<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title id="appTitle">Control de Gastos</title> 
    <meta name="theme-color" content="#1E3A8A">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* --- VARIABLES --- */
        :root {
            --primary-gradient: linear-gradient(135deg, #1E3A8A 0%, #2563EB 100%);
            --primary-color: #2563EB;
            --primary-dark: #1E3A8A;
            --success-color: #10B981;
            --success-bg: #F0FDF4;
            --success-border: #BBF7D0;
            --success-text: #15803D;
            --danger-color: #EF4444;
            --danger-soft: #F87171;
            --warning-color: #F59E0B;
            --secondary-color: #64748B;
            --bg-body: #F1F5F9;
            --bg-card: #FFFFFF;
            --text-main: #1E293B;
            --text-light: #FFFFFF;
            --border-color: #E2E8F0;
            --table-header-bg: #F8FAFC;
            --table-header-text: #475569;
            --table-zebra-bg: #F8FAFC;
            --color-cash: #10B981;
            --color-card: #2563EB;
            --color-transfer: #F59E0B;
            --nav-bg: #FFFFFF;
            --nav-active: #2563EB;
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-body: #0F172A; --bg-card: #1E293B; --text-main: #F8FAFC;
                --border-color: #334155; --nav-bg: #1E293B; --nav-active: #60A5FA;
                --table-header-bg: #1E293B; --table-header-text: #CBD5E1; --table-zebra-bg: #0F172A;
                --success-bg: #064E3B; --success-border: #065F46; --success-text: #D1FAE5;
                --secondary-color: #94A3B8;
            }
        }

        body {
            font-family: 'Segoe UI', Roboto, Arial, sans-serif;
            margin: 0; padding: 0;
            background-color: var(--bg-body); color: var(--text-main);
            max-width: 450px; margin: 0 auto; min-height: 100vh;
            padding-bottom: calc(65px + var(--safe-area-bottom)); 
            overscroll-behavior-y: contain; 
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* CURSOR TITILANTE */
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        .cursor-blink {
            display: inline-block; width: 2px; height: 1em; background-color: var(--primary-color);
            margin-left: 1px; animation: blink 1s step-end infinite; vertical-align: text-bottom;
        }

        /* --- PANTALLA DE BLOQUEO (PIN) --- */
        #lockScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--primary-gradient); z-index: 1000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            color: white;
        }
        .pin-display {
            font-size: 2em; margin: 20px 0; letter-spacing: 10px; font-weight: bold;
            min-height: 40px;
        }
        .pin-keypad {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;
        }
        .pin-btn {
            background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.3);
            color: white; font-size: 1.5em; width: 70px; height: 70px;
            border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .pin-btn:active { background: rgba(255, 255, 255, 0.4); }

        /* --- ESTADOS VAC칈OS (EMPTY STATES) --- */
        .empty-state {
            text-align: center; padding: 40px 20px; color: var(--secondary-color);
            display: none; animation: fadeIn 0.5s ease;
        }
        .empty-icon { font-size: 4em; margin-bottom: 15px; opacity: 0.7; }
        .empty-text { font-size: 1em; font-weight: 500; }

        /* --- ESTILOS GENERALES --- */
        h2, h3 { color: var(--text-main); text-align: center; }
        h2 { font-size: 1.3em; margin-top: 20px; color: var(--primary-color); font-weight: 700; }
        
        .header {
            display: flex; align-items: center; padding: 10px 15px;
            background: var(--primary-gradient); color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 50;
            justify-content: space-between;
        }
        #appLogo { font-size: 1em; font-weight: bold; color: white; display: flex; align-items: center; gap: 8px; }
        
        #headerSaldoContainer {
            background-color: rgba(255, 255, 255, 0.2); padding: 4px 10px;
            border-radius: 12px; font-size: 0.9em; font-weight: 600;
            display: flex; align-items: center; gap: 5px;
            border: 1px solid rgba(255,255,255,0.1); transition: all 0.3s ease;
        }
        
        .pantalla { display: none; padding: 15px; }
        .pantalla.activa { display: block; animation: fadeIn 0.3s ease-out forwards; }

        .form-group { margin-bottom: 10px; }
        label { display: block; margin-bottom: 3px; font-weight: 600; font-size: 0.9em; color: var(--secondary-color); }
        
        input[type="date"], input[type="text"], input[type="number"], select {
            width: 100%; padding: 10px; border: 1px solid var(--border-color);
            border-radius: 8px; box-sizing: border-box; font-size: 1em;
            background-color: var(--bg-card); color: var(--text-main); transition: border-color 0.2s;
        }
        input:focus, select:focus { outline: none; border-color: var(--primary-color); }

        button.btn {
            width: 100%; padding: 12px; border: none; border-radius: 8px;
            font-size: 1em; cursor: pointer; margin-top: 8px; font-weight: 600; transition: opacity 0.2s;
        }
        button.btn:active { opacity: 0.8; }
        .btn-primary { background: var(--primary-gradient); color: white; }
        .btn-danger { background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%); color: white; margin-top: 20px; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-secondary { background-color: var(--bg-card); color: var(--text-main); border: 1px solid var(--border-color); }
        .btn-ghost { background: transparent; border: 1px dashed var(--border-color); color: var(--secondary-color); margin-top: 15px; font-size: 0.9em;}

        .export-buttons-container { display: flex; gap: 10px; margin-top: 15px; }
        .export-buttons-container button { margin-top: 0; }

        button.btn-accion-tabla { 
            width: auto; padding: 5px 10px; font-size: 0.9em; margin: 0 2px; border-radius: 6px;
            background-color: transparent !important; border: 1px solid; 
        }
        .btn-accion-editar { color: var(--primary-color); border-color: var(--primary-color); }
        .btn-accion-borrar { color: var(--danger-color); border-color: var(--danger-color); }

        .tabla-gastos {
            width: 100%; border-collapse: collapse; margin-top: 15px; 
            background-color: var(--bg-card); box-shadow: var(--shadow-sm); border-radius: 8px; overflow: hidden;
        }
        .tabla-gastos th, .tabla-gastos td { padding: 12px 10px; text-align: left; font-size: 0.9em; }
        .tabla-gastos th { background-color: var(--table-header-bg); font-weight: 600; border-bottom: 2px solid var(--border-color); color: var(--table-header-text); }
        .tabla-gastos td { border-bottom: 1px solid var(--border-color); font-size: 0.95em; } 
        .tabla-gastos .gasto-categoria-subtexto { font-size: 0.75em; color: var(--secondary-color); margin-top: 2px; }
        .tabla-gastos tbody tr:nth-child(even) { background-color: var(--table-zebra-bg); }
        .tabla-gastos tr:hover:not(tfoot tr) { background-color: rgba(37, 99, 235, 0.05); cursor: pointer; }
        .tabla-gastos .gasto-valor { text-align: right; white-space: nowrap; font-weight: 600; }
        .tabla-gastos tfoot tr { font-weight: bold; background-color: var(--table-header-bg); border-top: 2px solid var(--border-color); }
        #tablaDetalleAnual tbody .gasto-valor { font-weight: normal; }

        .col-porcentaje { text-align: right !important; padding-right: 15px !important; }
        .text-right { text-align: right !important; }

        .payment-type-group { display: flex; justify-content: space-around; gap: 5px; }
        .payment-type-group input { display: none; }
        .payment-type-group label {
            flex-grow: 1; text-align: center; padding: 10px 5px;
            border: 1px solid var(--border-color); border-radius: 8px;
            cursor: pointer; font-size: 0.9em; background-color: var(--bg-card);
            display: flex; align-items: center; justify-content: center; gap: 5px; transition: all 0.2s;
        }
        .payment-type-group input:checked + label {
            background-color: #EFF6FF; border-color: var(--primary-color); font-weight: bold; color: var(--primary-color);
        }
        label[for*="Contado"] i { color: var(--color-cash) !important; }
        label[for*="Tarjeta"] i { color: var(--color-card) !important; }
        label[for*="Transf"] i { color: var(--color-transfer) !important; }

        .payment-filters-grid { display: flex; flex-wrap: nowrap; gap: 3px; width: 100%; }
        .payment-filters-grid label { 
            margin-bottom: 0; white-space: nowrap; padding: 2px 2px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: auto; min-height: 46px; border-radius: 6px;
        }
        .payment-filters-grid input:first-child + label { flex: 0 0 18%; width: 18%; }
        .payment-filters-grid input:not(:first-child) + label { flex: 0 0 26%; width: 26%; }
        .filter-header { font-size: 0.85em; display: flex; align-items: center; gap: 3px; opacity: 0.9; margin-bottom: 2px; font-weight: 600; }
        .filter-header i { font-size: 1.3em; }
        .filter-value { font-size: 1em; font-weight: 800; color: var(--primary-color); line-height: 1.1; }
        .label-todos .filter-header { font-size: 1.3em; margin-bottom: 1px; } 
        .label-todos .filter-value { font-size: 0.85em; font-weight: 600; opacity: 0.9; color: var(--text-main); }

        .nav-tabs {
            position: fixed; bottom: 0; left: 0; right: 0;
            display: flex; justify-content: space-around;
            background-color: var(--nav-bg); border-top: 1px solid var(--border-color);
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.05);
            max-width: 450px; margin: 0 auto; z-index: 100;
            height: 55px; padding-bottom: var(--safe-area-bottom);
        }
        .nav-tabs button {
            flex-grow: 1; border: none; background: transparent; position: relative;
            color: var(--secondary-color); font-size: 0.7em; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .nav-tabs button i { font-size: 1.4em; margin-bottom: 2px; }
        .nav-tabs button.active { color: var(--nav-active); font-weight: bold; }
        
        .backup-dot {
            position: absolute; top: 5px; right: 30%; width: 8px; height: 8px;
            background-color: var(--danger-color); border-radius: 50%;
            display: none; box-shadow: 0 0 0 2px var(--nav-bg);
        }

        .chart-container {
            background-color: var(--bg-card); padding: 15px; border-radius: 8px;
            box-shadow: var(--shadow-sm); margin-top: 20px; border: 1px solid var(--border-color);
            height: 350px; position: relative;
        }
        .filtro-container-inline { display: flex; gap: 10px; margin-bottom: 8px; }
        
        .pagination-controls {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color);
            font-size: 0.85em; white-space: nowrap;
        }
        .pagination-controls button { width: auto; margin: 0; padding: 4px 10px; font-size: 0.9em; }
        
        .modal { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); padding-top: 40px; }
        .modal-content {
            background-color: var(--bg-card); margin: 0 auto; padding: 20px;
            border: 1px solid var(--secondary-color); width: 90%; max-width: 400px; border-radius: 10px;
            max-height: 85vh; overflow-y: auto; 
        }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-botones-row { display: flex; gap: 10px; margin-top: 15px; }

        #toast { display: none; position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); padding: 12px 20px; border-radius: 25px; background-color: #1E293B; color: white; z-index: 300; }
        #toast.show { display: block; }
        #toast.success { background-color: var(--success-color); }
        #toast.error { background-color: var(--danger-color); }

        .dashboard-resumen { display: flex; gap: 10px; margin-bottom: 15px; margin-top: 5px; }
        .card-resumen {
            flex: 1; padding: 10px 5px; border-radius: 8px; text-align: center;
            background-color: var(--bg-card); box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color); position: relative; overflow: hidden;
        }
        .lbl-resumen { font-size: 0.85em; color: var(--secondary-color); display: block; text-transform: none; font-weight: 600; margin-bottom: 3px; }
        .val-resumen { font-size: 0.95em; font-weight: 700; white-space: nowrap; color: var(--text-main); }

        .filtro-wrapper { margin-top: 15px; padding: 5px 8px 8px 8px; border: 1px solid var(--border-color); border-radius: 8px; background-color: transparent; box-sizing: border-box; width: 100%; }
        .filtro-titulo { font-size: 0.75em; color: var(--secondary-color); padding: 0 5px; margin-left: 5px; font-weight: normal; text-transform: lowercase; }
        .filtro-titulo::first-letter { text-transform: uppercase; }

        .year-selector-container { display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 10px; margin-bottom: 10px; background-color: var(--bg-card); padding: 8px 15px; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); }
        .year-display { font-size: 1.1em; font-weight: 800; color: var(--primary-color); }
        .btn-year-nav { background: transparent; border: none; color: var(--secondary-color); font-size: 1.1em; cursor: pointer; padding: 5px 10px; margin: 0; width: auto; }
        .btn-year-nav:active { color: var(--primary-color); }

        #budgetProgressContainer { margin: 10px 0 15px 0; padding: 8px 10px; background-color: var(--table-header-bg); border-radius: 8px; border: 1px dashed var(--border-color); animation: fadeIn 0.3s ease; }
        .budget-bar-bg { background-color: #E2E8F0; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 5px; }
        .budget-bar-fill { height: 100%; width: 0%; transition: width 0.5s ease-out, background-color 0.3s; }
        .budget-info { display: flex; justify-content: space-between; font-size: 0.8em; font-weight: 600; color: var(--secondary-color); }
        .presupuesto-tag { font-size: 0.75em; background-color: #EFF6FF; color: var(--primary-color); padding: 2px 6px; border-radius: 4px; margin-left: 6px; border: 1px solid #BFDBFE; vertical-align: middle; }

        .btn-accordion { width: 100%; background-color: var(--bg-card); border: 1px solid var(--border-color); padding: 12px 15px; border-radius: 8px; margin-top: 15px; display: flex; justify-content: space-between; align-items: center; font-weight: 600; color: var(--text-main); cursor: pointer; box-shadow: var(--shadow-sm); transition: background-color 0.2s; }
        .btn-accordion:active { background-color: #F8FAFC; }
        .budget-list-container { display: none; background-color: var(--bg-card); border: 1px solid var(--border-color); border-top: none; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; padding: 15px; animation: fadeIn 0.2s ease-out; }
        .budget-row { margin-bottom: 12px; }
        .budget-row:last-child { margin-bottom: 0; }
        .budget-row-header { margin-bottom: 3px; font-size: 0.85em; color: var(--text-main); font-weight: 600; }
        .budget-visual-row { display: flex; align-items: center; gap: 8px; width: 100%; }
        .budget-list-track { flex: 0 0 65%; height: 8px; background-color: #E2E8F0; border-radius: 4px; overflow: hidden; }
        .budget-list-fill { height: 100%; border-radius: 4px; }
        .budget-text-info { flex: 0 0 35%; text-align: right; font-size: 0.75em; color: #1E293B; font-weight: normal; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .tr-clickable { cursor: pointer; transition: background-color 0.1s; }
        .tr-clickable:active { background-color: rgba(37, 99, 235, 0.05); }
        .cat-row-content { display: flex; align-items: center; gap: 5px; }

        .modal-chart-scroll-container { width: 100%; margin-bottom: 15px; display: none; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-body); }
        .modal-chart-wrapper { width: 100%; height: 220px; padding: 10px; background-color: var(--bg-card); }

        #gasto, #ingreso { padding: 15px; } 
        .input-card { background-color: var(--bg-card); border-radius: 16px; padding: 15px; box-shadow: var(--shadow-md); margin-bottom: 15px; }
        .smart-input-container { display: flex; flex-direction: column; gap: 8px; } 
        #gasto h2, #ingreso h2 { font-size: 1.1em; margin: 0 0 10px 0; text-align: left; }
        .row-date-val { display: flex; gap: 8px; align-items: center; margin-bottom: 5px; }
        .fecha-pill { background-color: var(--bg-body); border: 1px solid var(--border-color); color: var(--primary-color); font-weight: 600; padding: 0 12px; border-radius: 12px; white-space: nowrap; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 0.85em; height: 42px; }
        .smart-value-display { flex-grow: 1; font-size: 2.2em; font-weight: bold; color: var(--primary-color); background-color: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 12px; padding: 0 12px; margin: 0; letter-spacing: 0.5px; display: flex; justify-content: space-between; align-items: center; min-height: 42px; }
        .btn-backspace-inline { background: transparent; border: none; color: var(--danger-color); font-size: 0.5em; cursor: pointer; padding: 5px; opacity: 0.6; }
        .payment-pills-row { display: flex; gap: 6px; margin: 4px 0 8px 0; }
        .payment-pills-row input { display: none; }
        .payment-pills-row label { flex: 1; font-size: 0.75em; padding: 4px 0; border: 1px solid var(--border-color); border-radius: 20px; color: var(--secondary-color); text-align: center; background-color: var(--bg-body); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .payment-pills-row input:checked + label { background-color: #EFF6FF; border-color: var(--primary-color); color: var(--primary-color); font-weight: bold; }
        .smart-desc-input { flex-grow: 1; border: none; border-bottom: 1px dashed var(--border-color); border-radius: 0; padding: 8px 0; font-size: 1.05em; background: transparent; color: var(--text-main); }
        .smart-desc-input:focus { outline: none; border-color: var(--primary-color); border-bottom-style: solid; }
        
/* --- GRID DE CATEGOR칈AS (Dise침o Apps) --- */
        .smart-cat-grid { 
            display: grid; 
            grid-auto-flow: column; 
            grid-template-rows: repeat(2, 1fr); 
            grid-auto-columns: calc(25% - 5px); /* 4 Columnas exactas */
            gap: 8px 4px; /* Gap Vertical 8px, Horizontal 4px */
            overflow-x: auto; 
            overflow-y: hidden; 
            max-height: 135px; /* Altura ajustada para 2 filas de iconos */
            padding: 5px 2px; 
            margin-bottom: 5px; 
            scrollbar-width: none; 
        }
        .smart-cat-grid::-webkit-scrollbar { display: none; }
        
        .smart-cat-grid.expanded { 
            grid-template-rows: auto; 
            grid-auto-flow: row; 
            grid-template-columns: repeat(4, 1fr); 
            max-height: 250px; 
        }
        
        
/* CONTENEDOR DEL BOT칍N (Transparente, solo estructura) */
        .cat-btn { 
            background-color: transparent; 
            border: none; 
            padding: 0; 
            height: auto; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: flex-start; 
            cursor: pointer; 
            transition: transform 0.1s;
        }
        .cat-btn:active { transform: scale(0.95); }

/* EL AVATAR (C칤rculo) */
        .cat-btn-icon { 
            width: 44px;
            height: 44px;
            background-color: #F1F5F9; /* Gris muy claro por defecto */
            border: 1px solid var(--border-color);
            border-radius: 50%; /* C칤rculo perfecto */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em; /* Emoji grande */
            margin-bottom: 4px;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* EL TEXTO (Limpio, sin negrilla) */
        .cat-btn-text { 
            font-size: 0.75em; 
            color: var(--secondary-color);
            font-weight: 400; /* Texto ligero */
            text-align: center;
            line-height: 1.1;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

/* ESTADO SELECCIONADO (El c칤rculo se pinta, no el cuadrado entero) */
        .cat-btn.selected .cat-btn-icon { 
            background-color: var(--primary-color); 
            border-color: var(--primary-color);
            color: white; /* Emoji sobre azul */
            box-shadow: 0 3px 8px rgba(37, 99, 235, 0.4);
            transform: translateY(-2px);
        }

        .cat-btn.selected .cat-btn-text {
            color: var(--primary-color);
            font-weight: 600; /* Un poco de peso solo al seleccionar para destacar */
        }

        @keyframes pulse-blue { 0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7); transform: scale(1); } 50% { box-shadow: 0 0 0 6px rgba(37, 99, 235, 0); transform: scale(1.05); } 100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); transform: scale(1); } }

        /* Animaci칩n Flash */
        .cat-btn.flash .cat-btn-icon { animation: pulse-blue 0.4s ease-out; background-color: var(--primary-color); color: white; }
        .keypad-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 5px; }
        .key-btn { background-color: var(--bg-body); border: 1px solid var(--border-color); font-size: 1.3em; padding: 12px 0; border-radius: 12px; color: var(--text-main); cursor: pointer; box-shadow: 0 1px 1px rgba(0,0,0,0.05); font-weight: 500; }
        .key-btn:active { transform: translateY(1px); box-shadow: none; background-color: #E2E8F0; }
        .key-btn-success { background-color: var(--success-color); color: white; border-color: var(--success-color); }
        
        /* EMOJI BARRA MEJORADA */
        .emoji-bar {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 8px;
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
            padding: 5px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg-body);
        }
        .emoji-btn {
            font-size: 2.5em; /* EMOJIS MAS GRANDES */
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            border-radius: 8px;
            cursor: pointer;
            padding: 5px;
            display: flex; align-items: center; justify-content: center;
        }
        .emoji-btn:hover { background-color: #E2E8F0; }
        
        /* CARD FEEDBACK RESTAURADA */
        .last-action-card {
            background-color: var(--success-bg);
            border: 1px solid var(--success-border);
            border-radius: 12px;
            padding: 10px 15px;
            margin-top: 15px; /* Separacion del teclado */
            display: none; /* Oculto por defecto */
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
            cursor: pointer;
        }
        .last-action-icon { font-size: 1.5em; color: var(--success-text); }
        .last-action-details { display: flex; flex-direction: column; flex-grow: 1; }
        .last-action-title { font-size: 0.75em; color: var(--success-text); text-transform: uppercase; font-weight: bold; opacity: 0.8; margin-bottom: 2px; }
        .last-action-text { font-size: 0.95em; color: var(--text-main); font-weight: 500; }
        
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(24px); }

        /* --- ESTILOS AVATAR CATEGOR칈AS --- */
        .cat-row-wrapper { 
            display: flex; 
            align-items: center; 
            gap: 15px; /* Separaci칩n entre emoji y texto */
        }
        .cat-avatar {
            width: 50px; 
            height: 50px;
            background-color: var(--bg-body); /* Fondo adaptable (claro/oscuro) */
            border: 1px solid var(--border-color);
            border-radius: 50%; /* C칤rculo perfecto */
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-size: 2.2em; /* Emoji GRANDE */
            flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            padding-bottom: 4px; /* Peque침o ajuste visual para centrar emojis verticalmente */
        }
        .cat-name-styled {
            font-weight: 400;
            font-size: 1em;
            color: var(--text-main);
        }


/* --- TECLADO NUMPAD PRO (Dise침o Final) --- */
        .keypad-grid-pro {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 4 Columnas iguales */
            grid-template-rows: repeat(4, 1fr);    /* 4 Filas iguales */
            gap: 8px;
            height: 240px; /* Altura c칩moda y fija */
            margin-top: 5px;
        }

        /* Estilo base de botones */
        .keypad-grid-pro .key-btn {
            height: 100%;
            width: 100%;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            border-radius: 10px;
            background-color: #F8FAFC; /* Color base teclas */
            border: 1px solid var(--border-color);
        }

        /* Tecla CERO (Ocupa 2 espacios a la izquierda) */
        .key-zero-span {
            grid-column: 1 / 3; /* Ocupa columnas 1 y 2 */
            grid-row: 4;        /* Fila 4 */
        }

        /* Tecla PUNTO */
        .key-dot {
            grid-column: 3;
            grid-row: 4;
        }


        /* Bot칩n GUARDAR (Columna derecha, ocupa 3 filas) - APLICA A GASTO E INGRESO */
        #btnAddGasto, #btnAddIngreso {
            grid-column: 4;
            grid-row: 1 / 4; /* Desde fila 1 hasta el final de la 3 */
            background-color: transparent !important; 
            border: 2px solid var(--success-color) !important;
            color: var(--success-color) !important;
            font-size: 2.2em;
        }
        #btnAddGasto:active, #btnAddIngreso:active {
            background-color: rgba(16, 185, 129, 0.1) !important;
        }
 
        /* Bot칩n BORRAR (Columna derecha, 칰ltima fila) */
        .key-back-pos {
            grid-column: 4;
            grid-row: 4;
            color: var(--danger-color) !important;
            background-color: #FEF2F2 !important;
            border-color: #FECACA !important;
            font-size: 1.3em !important;
        }

        /* --- GRID DE CONFIGURACI칍N (Tarjetas) --- */
        .config-cat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 2 Columnas (50% c/u) */
            gap: 12px; /* Espacio entre tarjetas */
            margin-top: 10px;
        }

        .config-cat-card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 12px 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        .config-cat-card:active {
            transform: scale(0.96);
            background-color: var(--table-header-bg);
        }

        /* Avatar en la config (ligeramente m치s peque침o que en la lista) */
        .config-avatar {
            width: 42px; 
            height: 42px;
            background-color: var(--bg-body);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-size: 1.6em;
            flex-shrink: 0;
        }

        .config-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: hidden; /* Evita que textos largos rompan la tarjeta */
        }

        .config-name {
            font-weight: 600;
            font-size: 0.95em;
            color: var(--text-main);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; /* Puntos suspensivos... */
            line-height: 1.2;
        }

        .config-meta {
            font-size: 0.85em;
            color: var(--primary-color);
            font-weight: 700;
            margin-top: 2px;
        }
        
/* --- NUEVO GRID SUPERIOR DE CONFIGURACI칍N (3 Tarjetas) --- */
        .config-top-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 25px;
        }

        .config-mini-card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 10px 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            cursor: pointer;
            box-shadow: var(--shadow-sm);
            height: 105px; /* Altura fija para uniformidad */
            transition: transform 0.1s;
        }
        .config-mini-card:active { transform: scale(0.96); }

        .mini-card-icon { 
            font-size: 1.6em; 
            color: var(--secondary-color);
            margin-bottom: 2px;
            transition: color 0.3s;
        }
        
        /* Ajuste especial para que el switch quepa en la tarjeta */
        .mini-switch { transform: scale(0.75); margin: 0; }

        .mini-card-label { 
            font-size: 0.75em; 
            color: var(--secondary-color); 
            font-weight: 600; 
            text-align: center;
            margin-top: 2px;
        }

        /* --- ESTILOS PARA LAS LISTAS DE LOS NUEVOS MODALES --- */
        .option-list { list-style: none; padding: 0; margin: 10px 0 0 0; }
        
        .option-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between; /* Texto izq, Check derecha */
            font-size: 1.05em;
            color: var(--text-main);
        }
        .option-item:last-child { border-bottom: none; }
        .option-item:active { background-color: var(--table-header-bg); }
        
        /* Estado Seleccionado */
        .option-item.selected { 
            color: var(--primary-color); 
            font-weight: 700; 
            background-color: #EFF6FF; /* Azul muy suave */
        }
        
        .option-check { 
            color: var(--primary-color); 
            visibility: hidden; /* Oculto por defecto */
        }
        .option-item.selected .option-check { visibility: visible; }        
        /* Peque침a marca visual si tiene presupuesto */
        .has-budget::after {
            content: "";
            position: absolute;
            top: 0; right: 0;
            width: 0; height: 0;
            border-style: solid;
            border-width: 0 10px 10px 0;
            border-color: transparent var(--primary-color) transparent transparent;
            opacity: 0.5;
        }

        /* --- GESTI칍N DE DATOS (NUEVO DISE칌O) --- */
        .data-actions-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 15px;
        }

        .action-card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
            position: relative;
        }
        .action-card:active {
            transform: scale(0.98);
            background-color: #F8FAFC;
        }

        /* Iconos de las tarjetas (con fondo suave) */
        .action-icon-box {
            width: 45px;
            height: 45px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4em;
            flex-shrink: 0;
        }
        
        .icon-backup { background-color: #ECFDF5; color: #10B981; } /* Verde suave */
        .icon-restore { background-color: #EFF6FF; color: #3B82F6; } /* Azul suave */

        .action-text-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .action-title {
            font-size: 1em;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 2px;
        }

        .action-subtitle {
            font-size: 0.8em;
            color: var(--secondary-color);
        }

        .action-arrow {
            color: #CBD5E1;
            font-size: 1.1em;
        }

        /* --- ZONA DE PELIGRO (BOT칍N BORRAR) --- */
        .danger-zone {
            margin-top: 40px; /* Separaci칩n generosa */
            padding-top: 20px;
            border-top: 1px dashed var(--border-color);
            text-align: center;
        }

        .btn-danger-zone {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #EF4444 0%, #B91C1C 100%); /* Degradado Rojo */
            color: white;
            font-size: 1em;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(239, 68, 68, 0.25);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: transform 0.1s;
        }
        .btn-danger-zone:active {
            transform: scale(0.97);
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
        }
        /* Estilo especial para la tarjeta de "A침adir Nueva" */
        .config-cat-card.add-new {
            border: 2px dashed var(--primary-color);
            background-color: rgba(37, 99, 235, 0.03);
            justify-content: center;
            color: var(--primary-color);
            opacity: 0.8;
        }
        .config-cat-card.add-new:active {
            background-color: rgba(37, 99, 235, 0.1);
            opacity: 1;
        }
        .config-cat-card.add-new .config-avatar {
            background-color: transparent;
            border: none;
            color: var(--primary-color);
            font-size: 1.4em;
        }
        .config-cat-card.add-new .config-name {
            color: var(--primary-color);
            font-weight: 700;
        }

        /* --- OPTIMIZACI칍N ESPACIO VERTICAL (MODO COMPACTO) --- */

        /* 1. Teclado m치s bajo y compacto */
        .keypad-grid-pro {
            height: 200px !important; /* Bajamos de 240px a 200px */
            gap: 5px !important;
            margin-top: 5px !important;
        }
        .keypad-grid-pro .key-btn {
            font-size: 1.4em !important; /* Texto un pel칤n m치s peque침o */
            border-radius: 8px !important;
        }

        /* 2. Reducir m치rgenes de los inputs superiores */
        .input-card { padding: 10px 15px !important; } /* Menos relleno en la tarjeta blanca */
        .row-date-val { margin-bottom: 2px !important; } /* Pegar fecha al valor */
        .payment-pills-row { margin: 2px 0 5px 0 !important; } /* Pegar pastillas de pago */
        .smart-desc-input { padding: 4px 0 !important; font-size: 1em !important; } /* Input descripci칩n m치s fino */
        
        /* Ocultar el t칤tulo H2 en m칩viles peque침os si molesta */
        #gasto h2, #ingreso h2 { margin: 0 0 5px 0 !important; font-size: 1em !important; }

        /* 3. BARRA DE CONFIRMACI칍N "SLIM" */
        .last-action-card {
            margin-top: 5px !important;    /* Pegado al teclado */
            padding: 6px 12px !important;  /* Relleno m칤nimo */
            border-radius: 8px !important;
            min-height: 36px;              /* Altura fija peque침a */
            display: none;                 /* Oculto por defecto */
        }

        /* Ocultar el t칤tulo "GASTO GUARDADO" para ahorrar una l칤nea */
        .last-action-title { display: none !important; } 

        /* Icono m치s discreto */
        .last-action-icon { font-size: 1.1em !important; margin-right: 8px; }

        /* Texto en una sola l칤nea con puntos suspensivos (...) */
        .last-action-text {
            font-size: 0.85em !important;
            white-space: nowrap;      /* Obliga a una sola l칤nea */
            overflow: hidden;         /* Corta lo que sobra */
            text-overflow: ellipsis;  /* Pone los ... al final */
            display: block;
            width: 100%;
            font-weight: 600;
        }
        /* --- AJUSTES FINALES DE ESPACIO (INPUT C칍MODO + TARJETA DESPEJADA) --- */

        /* 1. Input de Descripci칩n: Recuperamos su altura c칩moda */
        .smart-desc-input { 
            padding: 8px 0 !important;    /* Volvemos a 8px (antes era 4px) */
            font-size: 1.05em !important; /* Letra un poco m치s grande y legible */
        }

        /* 2. Tarjeta de Confirmaci칩n: M치s separada del teclado */
        .last-action-card {
            margin-top: 15px !important;   /* Aumentamos de 5px a 15px para que no "pise" botones */
            padding: 8px 15px !important;  /* Un poco m치s de cuerpo */
            min-height: 40px;              /* Altura m칤nima asegurada */
            border-radius: 10px !important;
        }

        /* Mantenemos el teclado compacto para compensar */
        .keypad-grid-pro {
            height: 200px !important;
            gap: 5px !important;
            margin-top: 5px !important;
        }
        
        /* Ajuste de m치rgenes internos */
        .input-card { padding: 12px 15px !important; }
        .row-date-val { margin-bottom: 5px !important; }
        /* --- AJUSTES FINALES (Teclado, Categor칤as y Espacios) --- */

        /* 1. Categor칤as Expandidas: Altura inteligente y "colch칩n" abajo */
        .smart-cat-grid.expanded {
            max-height: 45vh !important;    /* Puede crecer hasta casi la mitad de la pantalla */
            padding-bottom: 30px !important; /* Espacio EXTRA abajo para que se lea el texto de la 칰ltima fila */
        }

        /* 2. Bot칩n BACK (Unificado: Gris igual que los n칰meros) */
        .key-back-pos {
            background-color: #F8FAFC !important; /* Mismo color que las teclas num칠ricas */
            border-color: var(--border-color) !important;
            color: var(--danger-color) !important; /* Solo el 칤cono queda rojo */
        }
        .key-back-pos:active {
            background-color: #E2E8F0 !important; /* Efecto pulsado est치ndar */
        }

        /* 3. Bot칩n GUARDAR (Borde m치s fino) */
        #btnAddGasto, #btnAddIngreso {
            border-width: 1px !important; /* M치s elegante */
        }

        /* 4. Ajustes de Espacio (Para que la tarjeta no pise el teclado) */
        .keypad-grid-pro {
            height: 210px !important;       /* Altura c칩moda */
            margin-top: 10px !important;
        }
        .last-action-card {
            margin-top: 15px !important;    /* Separaci칩n clara del teclado */
            margin-bottom: 5px !important;
        }
        .smart-desc-input {
            padding: 8px 0 !important;      /* Input con altura c칩moda */
        }
    </style>
</head>
<body>
    <div id="lockScreen">
        <div style="font-size: 4em; margin-bottom: 20px;"><i class="fas fa-lock"></i></div>
        <h2 style="color: white; margin-top:0;">Seguridad</h2>
        <div id="pinDisplay" class="pin-display"></div>
        <div class="pin-keypad">
            <div class="pin-btn" onclick="ingresarPin('1')">1</div>
            <div class="pin-btn" onclick="ingresarPin('2')">2</div>
            <div class="pin-btn" onclick="ingresarPin('3')">3</div>
            <div class="pin-btn" onclick="ingresarPin('4')">4</div>
            <div class="pin-btn" onclick="ingresarPin('5')">5</div>
            <div class="pin-btn" onclick="ingresarPin('6')">6</div>
            <div class="pin-btn" onclick="ingresarPin('7')">7</div>
            <div class="pin-btn" onclick="ingresarPin('8')">8</div>
            <div class="pin-btn" onclick="ingresarPin('9')">9</div>
            <div class="pin-btn" onclick="ingresarPin('back')"><i class="fas fa-backspace" style="font-size: 0.7em;"></i></div>
            <div class="pin-btn" onclick="ingresarPin('0')">0</div>
            <div class="pin-btn" onclick="verificarPin()">游</div>
        </div>
        <p id="pinError" style="color: #FCA5A5; margin-top: 15px; display: none;">PIN Incorrecto</p>
    </div>

    <div class="header">
        <span id="appLogo"><i class="fas fa-wallet"></i> <span data-i18n="appTitle">Control de Gastos</span></span>
        <div id="headerSaldoContainer">
            <span data-i18n="lblDispCorto">Disp:</span> <span id="headerSaldoValor">...</span>
        </div>
    </div>

    <div id="gasto" class="pantalla activa">
        <div class="input-card">
            <div id="formulario-gasto" class="smart-input-container">
                <div class="row-date-val">
                    <button class="fecha-pill" id="smartFechaBtn" onclick="cambiarFechaSmart('gastoFecha')">
                        <i class="far fa-calendar-alt"></i> <span id="smartFechaTexto">Hoy</span>
                    </button>
                    <input type="date" id="gastoFecha" style="display:none;">
                    <div class="smart-value-display">
                        <span id="smartValueDisplay" style="width: 100%; text-align: right; margin-right: 10px;">0.00</span>
                        <div class="cursor-blink" id="cursorGasto"></div>
                    </div>
                </div>
                <div class="payment-pills-row">
                    <input type="radio" id="pagoContado" name="tipoPago" value="Contado" checked>
                    <label for="pagoContado"><i class="fas fa-coins"></i> <span data-i18n="lblContado">Contado</span></label>
                    <input type="radio" id="pagoTarjeta" name="tipoPago" value="Tarjeta">
                    <label for="pagoTarjeta"><i class="far fa-credit-card"></i> <span data-i18n="lblTarjeta">Tarjeta</span></label>
                    <input type="radio" id="pagoTransferencia" name="tipoPago" value="Transferencia">
                    <label for="pagoTransferencia"><i class="fas fa-mobile-alt"></i> <span data-i18n="lblTransf">Transf.</span></label>
                </div>
                <input type="text" id="gastoDescripcion" class="smart-desc-input" placeholder="쮼n qu칠 gastaste?" autocomplete="off" list="sugerenciasDescripciones" onkeyup="predecirCategoria()">
                <datalist id="sugerenciasDescripciones"></datalist>
                <div id="smartCategories" class="smart-cat-grid"></div>
                <input type="hidden" id="gastoCategoria" value=""> 
                <div id="budgetProgressContainer" style="display:none;">
                    <div class="budget-info">
                        <span id="budgetLabel" data-i18n="lblMeta">Meta Mensual</span>
                        <span id="budgetValue"></span>
                    </div>
                    <div class="budget-bar-bg">
                        <div id="budgetProgressBar" class="budget-bar-fill"></div>
                    </div>
                </div>
                    <div id="keypadContainer" class="keypad-container-gasto">
                        <div class="keypad-grid-pro">
                            <button class="key-btn" onclick="tecladoPress('1')">1</button>
                            <button class="key-btn" onclick="tecladoPress('2')">2</button>
                            <button class="key-btn" onclick="tecladoPress('3')">3</button>
                            
                            <button class="key-btn" id="btnAddGasto" onclick="agregarGasto()">
                                <i class="fas fa-check"></i>
                            </button>

                            <button class="key-btn" onclick="tecladoPress('4')">4</button>
                            <button class="key-btn" onclick="tecladoPress('5')">5</button>
                            <button class="key-btn" onclick="tecladoPress('6')">6</button>
                            
                            <button class="key-btn" onclick="tecladoPress('7')">7</button>
                            <button class="key-btn" onclick="tecladoPress('8')">8</button>
                            <button class="key-btn" onclick="tecladoPress('9')">9</button>
                            
                            <button class="key-btn key-zero-span" onclick="tecladoPress('0')">0</button>
                            <button class="key-btn key-dot" onclick="tecladoPress('.')">.</button>
                            <button class="key-btn key-back-pos" onclick="tecladoPress('back')">
                                <i class="fas fa-backspace"></i>
                            </button>
                        </div>
                    </div>
                <div id="feedbackUltimoGasto" class="last-action-card" onclick="toggleTablaGastos()">
                    <div class="last-action-icon"><i class="fas fa-check-circle"></i></div>
                    <div class="last-action-details">
                        <span class="last-action-title" data-i18n="msgGastoGuardado">Gasto Guardado</span>
                        <span id="feedbackTexto" class="last-action-text"></span>
                    </div>
                    <div style="color: var(--secondary-color); font-size: 0.8em;"><i class="fas fa-chevron-down"></i></div>
                </div>
                <input type="hidden" id="gastoValor">
            </div>
        </div>

        <button class="btn btn-ghost" id="btnToggleGastos" onclick="toggleTablaGastos()">
            拘勇 <span data-i18n="titleGastosMes">칔ltimos Gastos</span>
        </button>
        <div id="emptyStateGasto" class="empty-state">
            <div class="empty-icon">游꼒</div>
            <div class="empty-text">A칰n no tienes gastos este mes.<br>춰Buen trabajo!</div>
        </div>
        <div id="contenedorUltimosGastos">
            <table id="tablaUltimosGastos" class="tabla-gastos">
                <thead><tr><th data-i18n="colFecha">Fecha</th><th data-i18n="colDesc">Descripci칩n</th><th style="text-align: right;" data-i18n="colValor">Valor</th></tr></thead>
                <tbody></tbody>
                <tfoot><tr><td colspan="2" data-i18n="lblTotal">TOTAL</td><td id="totalUltimosGastos" class="gasto-valor"></td></tr></tfoot>
            </table>
            <div class="pagination-controls" style="margin-bottom: 20px;">
                <button class="btn btn-secondary" onclick="cambiarPaginaPrincipal(-1)">Ant</button>
                <span id="pageInfoPrincipal">P치g 1</span>
                <button class="btn btn-secondary" onclick="cambiarPaginaPrincipal(1)">Sig</button>
            </div>
        </div>
    </div>

    <div id="ingreso" class="pantalla">
        <div class="input-card">
            <div id="formulario-ingreso" class="smart-input-container">
                <h2 data-i18n="titleIngresoDinero" style="text-align:left; margin-bottom:10px; font-size:1.1em;">Nuevo Ingreso</h2> 
                <div class="row-date-val">
                    <button class="fecha-pill" id="smartFechaIngresoBtn" onclick="cambiarFechaSmart('ingresoFecha')">
                        <i class="far fa-calendar-alt"></i> <span id="smartFechaIngresoTexto">Hoy</span>
                    </button>
                    <input type="date" id="ingresoFecha" style="display:none;">
                    <div class="smart-value-display">
                        <span id="smartValueDisplayIngreso" style="width: 100%; text-align: right; margin-right: 10px;">0.00</span>
                        <div class="cursor-blink" id="cursorIngreso"></div>
                    </div>
                </div>
                <input type="text" id="ingresoDescripcion" class="smart-desc-input" data-i18n-ph="phDescIngreso" placeholder="쯆rigen del ingreso?" autocomplete="off" style="margin-top:10px; margin-bottom:10px;" list="sugerenciasIngresos">
                <datalist id="sugerenciasIngresos"></datalist>
                <div class="keypad-grid-pro">
                    <button class="key-btn" onclick="tecladoPress('1')">1</button>
                    <button class="key-btn" onclick="tecladoPress('2')">2</button>
                    <button class="key-btn" onclick="tecladoPress('3')">3</button>
                    
                    <button class="key-btn" id="btnAddIngreso" onclick="agregarIngreso()">
                        <i class="fas fa-check"></i>
                    </button>

                    <button class="key-btn" onclick="tecladoPress('4')">4</button>
                    <button class="key-btn" onclick="tecladoPress('5')">5</button>
                    <button class="key-btn" onclick="tecladoPress('6')">6</button>
                    
                    <button class="key-btn" onclick="tecladoPress('7')">7</button>
                    <button class="key-btn" onclick="tecladoPress('8')">8</button>
                    <button class="key-btn" onclick="tecladoPress('9')">9</button>
                    
                    <button class="key-btn key-zero-span" onclick="tecladoPress('0')">0</button>
                    <button class="key-btn key-dot" onclick="tecladoPress('.')">.</button>
                    <button class="key-btn key-back-pos" onclick="tecladoPress('back')">
                        <i class="fas fa-backspace"></i>
                    </button>
                </div>
                <div id="feedbackUltimoIngreso" class="last-action-card" onclick="toggleTablaIngresos()">
                    <div class="last-action-icon"><i class="fas fa-piggy-bank"></i></div>
                    <div class="last-action-details">
                        <span class="last-action-title" data-i18n="msgIngresoGuardado">Ingreso Guardado</span>
                        <span id="feedbackTextoIngreso" class="last-action-text"></span>
                    </div>
                    <div style="color: var(--secondary-color); font-size: 0.8em;"><i class="fas fa-chevron-down"></i></div>
                </div>
                <input type="hidden" id="ingresoValor">
            </div>
        </div>
        
        <button class="btn btn-ghost" id="btnToggleIngresos" onclick="toggleTablaIngresos()">
            拘勇 <span data-i18n="titleIngresosMes">칔ltimos Ingresos</span>
        </button>
        <div id="emptyStateIngreso" class="empty-state">
            <div class="empty-icon">游눯</div>
            <div class="empty-text">Sin ingresos registrados este a침o.</div>
        </div>
        <div id="contenedorUltimosIngresos">
            <div class="year-selector-container">
                <button class="btn-year-nav" onclick="cambiarAnioIngreso(-1)"><i class="fas fa-chevron-left"></i></button>
                <span id="displayAnioIngreso" class="year-display">2025</span>
                <button class="btn-year-nav" onclick="cambiarAnioIngreso(1)"><i class="fas fa-chevron-right"></i></button>
            </div>
            <table id="tablaUltimosIngresos" class="tabla-gastos">
                <thead><tr><th data-i18n="colFecha">Fecha</th><th data-i18n="colDesc">Descripci칩n</th><th style="text-align: right;" data-i18n="colValor">Valor</th></tr></thead>
                <tbody></tbody>
                <tfoot><tr><td colspan="2" data-i18n="lblTotal">TOTAL</td><td id="totalUltimosIngresos" class="gasto-valor"></td></tr></tfoot>
            </table>
            <div class="pagination-controls" style="margin-bottom: 20px;">
                <button class="btn btn-secondary" onclick="cambiarPaginaIngresos(-1)">Ant</button>
                <span id="pageInfoIngresos">P치g 1</span>
                <button class="btn btn-secondary" onclick="cambiarPaginaIngresos(1)">Sig</button>
            </div>
            <div class="export-buttons-container">
                <button class="btn btn-secondary" onclick="generarYCompartirCSV('ingresos_mes')" style="flex:1;">
                    <i class="fas fa-file-excel" style="color: #10B981; margin-right: 5px;"></i> <span data-i18n="btnCsvMes">Excel</span>
                </button> 
                <button class="btn btn-secondary" onclick="generarPDF('ingresos_mes')" style="flex:1;">
                    <i class="fas fa-file-pdf" style="color: #EF4444; margin-right: 5px;"></i> PDF
                </button>
            </div>
        </div>
    </div>
    
    <div id="mensual" class="pantalla">
        <h2 data-i18n="titleResumenMensual">Resumen Mensual</h2>
        <div class="filtro-container-inline">
            <select id="filtroMes" onchange="actualizarResumenMensual()"></select>
            <select id="filtroAnioMensual" onchange="actualizarResumenMensual()"></select>
        </div>
        <div class="dashboard-resumen">
            <div class="card-resumen">
                <span class="lbl-resumen" data-i18n="lblIngreso">Ingreso</span>
                <span id="dashIngreso" class="val-resumen">0</span>
            </div>
            <div class="card-resumen">
                <span class="lbl-resumen" data-i18n="lblGasto">Gasto</span>
                <span id="dashGasto" class="val-resumen">0</span>
            </div>
            <div class="card-resumen">
                <span class="lbl-resumen" data-i18n="lblDisponible">Disponible</span>
                <span id="dashBalance" class="val-resumen">0</span>
            </div>
        </div>
        <button class="btn-accordion" onclick="togglePresupuestos()">
            <span>游꿢 Ver Estado de Presupuestos</span>
            <i class="fas fa-chevron-down" id="budgetChevron"></i>
        </button>
        <div id="budgetSummaryContainer" class="budget-list-container"></div>
        <fieldset class="filtro-wrapper">
            <legend class="filtro-titulo" data-i18n="lblFiltroPago">filtro por tipo de pago</legend>
            <div class="payment-type-group payment-filters-grid">
                <input type="radio" id="filtroPagoTotalMensual" name="filtroTipoPagoMensual" value="TODOS" checked>
                <label for="filtroPagoTotalMensual" class="label-todos">
                    <div class="filter-header"><i class="fas fa-list-ul"></i></div>
                    <div class="filter-value" data-i18n="lblVerTodos">Todo</div>
                </label>
                <input type="radio" id="filtroPagoContadoMensual" name="filtroTipoPagoMensual" value="Contado">
                <label for="filtroPagoContadoMensual">
                    <div class="filter-header"><i class="fas fa-coins"></i> <span data-i18n="lblContado">Efectivo</span></div>
                    <div class="filter-value" id="sum-contado-mensual">$0</div>
                </label>
                <input type="radio" id="filtroPagoTarjetaMensual" name="filtroTipoPagoMensual" value="Tarjeta">
                <label for="filtroPagoTarjetaMensual">
                    <div class="filter-header"><i class="far fa-credit-card"></i> <span data-i18n="lblTarjeta">Tarjeta</span></div>
                    <div class="filter-value" id="sum-tarjeta-mensual">$0</div>
                </label>
                <input type="radio" id="filtroPagoTransfMensual" name="filtroTipoPagoMensual" value="Transferencia">
                <label for="filtroPagoTransfMensual">
                    <div class="filter-header"><i class="fas fa-mobile-alt"></i> <span data-i18n="lblTransf">Transf.</span></div>
                    <div class="filter-value" id="sum-transf-mensual">$0</div>
                </label>
            </div>
        </fieldset>
        <h3 data-i18n="titleTotalCategoria">Total por Categor칤a</h3>
        <div id="emptyStateMensual" class="empty-state">
            <div class="empty-icon">游늵</div>
            <div class="empty-text">Sin datos para este mes.</div>
        </div>
        <table id="tablaResumenMensual" class="tabla-gastos">
            <thead><tr><th data-i18n="colCategoria">Categor칤a</th><th style="text-align: right;" data-i18n="colTotal">Total</th><th class="col-porcentaje">%</th></tr></thead>
            <tbody></tbody>
            <tfoot><tr><td data-i18n="lblTotal">TOTAL</td><td></td><td id="totalResumenMensual" class="gasto-valor"></td></tr></tfoot>
        </table>
        <div class="chart-container" id="chartMensualContainer"><canvas id="chartMensualCanvas"></canvas></div>
        <div class="export-buttons-container">
            <button class="btn btn-secondary" id="btnExportMes" onclick="generarYCompartirCSV('mensual')" style="flex:1;">
                <i class="fas fa-file-excel" style="color: #10B981; margin-right: 5px;"></i> <span data-i18n="btnCsvMes">Excel</span>
            </button> 
            <button class="btn btn-secondary" onclick="generarPDF('mensual')" style="flex:1;">
                <i class="fas fa-file-pdf" style="color: #EF4444; margin-right: 5px;"></i> PDF
            </button>
        </div>
    </div>

    <div id="historico" class="pantalla">
        <h2 data-i18n="titleResumenAnual">Resumen Anual</h2>
        <div class="filtro-container-inline">
            <select id="filtroAnioHistorico" onchange="actualizarResumenHistorico(true)"></select>
        </div>
        <div class="dashboard-resumen">
            <div class="card-resumen">
                <span class="lbl-resumen" data-i18n="lblIngreso">Ingreso</span>
                <span id="dashIngresoHistorico" class="val-resumen">0</span>
            </div>
            <div class="card-resumen">
                <span class="lbl-resumen" data-i18n="lblGasto">Gasto</span>
                <span id="dashGastoHistorico" class="val-resumen">0</span>
            </div>
            <div class="card-resumen">
                <span class="lbl-resumen" data-i18n="lblDisponible">Disponible</span>
                <span id="dashBalanceHistorico" class="val-resumen">0</span>
            </div>
        </div>
        <fieldset class="filtro-wrapper">
            <legend class="filtro-titulo" data-i18n="lblFiltroPago">filtro por tipo de pago</legend>
            <div class="payment-type-group payment-filters-grid">
                <input type="radio" id="filtroPagoTotalHistorico" name="filtroTipoPagoHistorico" value="TODOS" checked>
                <label for="filtroPagoTotalHistorico" class="label-todos">
                    <div class="filter-header"><i class="fas fa-list-ul"></i></div>
                    <div class="filter-value" data-i18n="lblVerTodos">Todo</div>
                </label>
                <input type="radio" id="filtroPagoContadoHistorico" name="filtroTipoPagoHistorico" value="Contado">
                <label for="filtroPagoContadoHistorico">
                    <div class="filter-header"><i class="fas fa-coins"></i> <span data-i18n="lblContado">Efectivo</span></div>
                    <div class="filter-value" id="sum-contado-historico">$0</div>
                </label>
                <input type="radio" id="filtroPagoTarjetaHistorico" name="filtroTipoPagoHistorico" value="Tarjeta">
                <label for="filtroPagoTarjetaHistorico">
                    <div class="filter-header"><i class="far fa-credit-card"></i> <span data-i18n="lblTarjeta">Tarjeta</span></div>
                    <div class="filter-value" id="sum-tarjeta-historico">$0</div>
                </label>
                <input type="radio" id="filtroPagoTransfHistorico" name="filtroTipoPagoHistorico" value="Transferencia">
                <label for="filtroPagoTransfHistorico">
                    <div class="filter-header"><i class="fas fa-mobile-alt"></i> <span data-i18n="lblTransf">Transf.</span></div>
                    <div class="filter-value" id="sum-transf-historico">$0</div>
                </label>
            </div>
        </fieldset>
        <h3 data-i18n="titleTotalCatAnio">Total Categor칤as (A침o)</h3>
        <table id="tablaResumenHistorico" class="tabla-gastos">
            <thead><tr><th data-i18n="colCategoria">Categor칤a</th><th style="text-align: right;" data-i18n="colTotal">Total</th><th class="col-porcentaje">%</th></tr></thead>
            <tbody></tbody>
            <tfoot><tr><td data-i18n="lblTotal">TOTAL</td><td></td><td id="totalResumenHistorico" class="gasto-valor"></td></tr></tfoot>
        </table>
        <div class="chart-container" id="chartHistoricoContainer"><canvas id="chartHistoricoCanvas"></canvas></div>
        <h3 style="margin-top: 20px;">Evoluci칩n Ingresos vs Gastos</h3>
        <div class="chart-container" id="chartHistoricoMesesContainer"><canvas id="chartHistoricoMesesCanvas"></canvas></div>
        <div style="margin-top: 20px;">
            <button class="btn btn-secondary" onclick="abrirModalTablaAnual()">
                游늯 <span data-i18n="titleDetalleMensual">Ver Detalle Mensual</span>
            </button>
        </div>
        <div class="export-buttons-container">
            <button class="btn btn-secondary" id="btnExportYear" onclick="generarYCompartirCSV('historico')" style="flex:1;">
                <i class="fas fa-file-excel" style="color: #10B981; margin-right: 5px;"></i> <span data-i18n="btnCsvAnio">Excel</span>
            </button> 
            <button class="btn btn-secondary" onclick="generarPDF('historico')" style="flex:1;">
                <i class="fas fa-file-pdf" style="color: #EF4444; margin-right: 5px;"></i> PDF
            </button>
        </div>
    </div>


    <div id="configuracion" class="pantalla">
        <h2 data-i18n="menuConfig">Configuraci칩n</h2>
        
        <div class="config-top-grid">
            
            <div class="config-mini-card" onclick="triggerTogglePin(event)">
                <i class="fas fa-lock mini-card-icon" id="iconLockState"></i>
                <label class="toggle-switch mini-switch" onclick="event.stopPropagation()">
                    <input type="checkbox" id="togglePin" onchange="toggleSeguridad(this)">
                    <span class="slider"></span>
                </label>
                <span class="mini-card-label">PIN</span>
            </div>

            <div class="config-mini-card" onclick="abrirModalMoneda()">
                <div class="mini-card-icon" id="displayMonedaCard" style="font-weight:bold; font-family:sans-serif;">$</div>
                <div style="font-size:0.8em; color:var(--secondary-color);">Cambiar</div>
                <span class="mini-card-label" data-i18n="lblMoneda">Moneda</span>
            </div>

            <div class="config-mini-card" onclick="abrirModalIdioma()">
                <i class="fas fa-globe mini-card-icon"></i>
                <div id="displayIdiomaCard" style="font-size:0.8em; font-weight:bold; color:var(--text-main);">ES</div>
                <span class="mini-card-label" data-i18n="lblIdioma">Idioma</span>
            </div>
        </div>
        
        <h3 data-i18n="titleCategorias" style="margin-top: 25px;">Personaliza tus Categor칤as</h3>
        
        <div id="gridCategoriasConfig" class="config-cat-grid"></div>

        <h3 style="margin-top: 30px;" data-i18n="titleDatos">Gesti칩n de Datos</h3>
        
        <div class="data-actions-container">
            <div class="action-card" onclick="compartirBackupJSON()">
                <div class="action-icon-box icon-backup">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div class="action-text-content">
                    <span class="action-title" data-i18n="btnBackup">Crear Copia de Seguridad</span>
                    <span class="action-subtitle">Descargar archivo .txt</span>
                </div>
                <i class="fas fa-chevron-right action-arrow"></i>
            </div>

            <input type="file" id="inputImportar" style="display: none;">
            <div class="action-card" onclick="document.getElementById('inputImportar').click()">
                <div class="action-icon-box icon-restore">
                    <i class="fas fa-cloud-download-alt"></i>
                </div>
                <div class="action-text-content">
                    <span class="action-title" data-i18n="btnImportar">Restaurar Datos</span>
                    <span class="action-subtitle">Desde archivo local</span>
                </div>
                <i class="fas fa-chevron-right action-arrow"></i>
            </div>
        </div>

        <div class="danger-zone">
            <button class="btn-danger-zone" onclick="confirmarLimpiarTodosLosDatos()">
                <i class="fas fa-exclamation-triangle"></i>
                <span data-i18n="btnBorrarTodo">Eliminar Todos los Datos</span>
            </button>
            <p style="font-size: 0.75em; color: var(--secondary-color); margin-top: 10px;">
                Esta acci칩n no se puede deshacer.
            </p>
        </div>        

    </div>
    
    <div id="modalDetalleGastos" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="cerrarModalDetalle()">&times;</span>
            <h3 style="margin-top:0; margin-bottom:15px;"><span data-i18n="titleDetalle">Detalle</span>: <span id="modalDetalleCategoriaTitulo" style="color: var(--primary-color);"></span></h3>
            <div class="modal-chart-scroll-container" id="modalChartContainer">
                <div class="modal-chart-wrapper">
                    <canvas id="modalChartCanvas"></canvas>
                </div>
            </div>
            <input type="text" id="buscarDetalleModal" class="input-buscar" data-i18n-ph="phBuscar" placeholder="Buscar..." onkeyup="filtrarTablaDetalle()">
            <table id="tablaDetalleModal" class="tabla-gastos">
                <thead><tr><th data-i18n="colFecha">Fecha</th><th data-i18n="colDesc">Descripci칩n</th><th data-i18n="colValor">Valor</th></tr></thead>
                <tbody></tbody>
                <tfoot><tr><td colspan="2" data-i18n="lblTotalGeneral">TOTAL GENERAL</td><td id="totalDetalleModal" class="gasto-valor"></td></tr></tfoot>
            </table>
            <div class="pagination-controls" id="paginacionDetalleModal">
                <button class="btn btn-secondary" onclick="cambiarPagina(-1)">Ant</button>
                <span id="pageInfoModal">P치g 1</span>
                <button class="btn btn-secondary" onclick="cambiarPagina(1)">Sig</button>
            </div>
            <button class="btn btn-secondary" style="margin-top:15px;" onclick="cerrarModalDetalle()" data-i18n="btnVolver">Volver</button>
        </div>
    </div>

    <div id="modalTablaAnual" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="cerrarModalTablaAnual()">&times;</span>
            <h3 style="margin-top:0; margin-bottom:15px;" data-i18n="titleDetalleMensual">Detalle Mensual</h3>
            <table id="tablaDetalleAnual" class="tabla-gastos">
                <thead>
                    <tr>
                        <th data-i18n="colMes">Mes</th>
                        <th class="text-right" data-i18n="colIngreso">Ingreso</th>
                        <th class="text-right" data-i18n="colGasto">Gasto</th>
                        <th class="text-right" data-i18n="colSaldo">Saldo</th>
                    </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                    <tr>
                        <td data-i18n="lblTotal">TOTAL</td>
                        <td id="totalAnualIngreso" class="gasto-valor"></td>
                        <td id="totalAnualGasto" class="gasto-valor"></td>
                        <td id="totalAnualSaldo" class="gasto-valor"></td>
                    </tr>
                </tfoot>
            </table>
            <button class="btn btn-secondary" style="margin-top:20px;" onclick="cerrarModalTablaAnual()" data-i18n="btnVolver">Volver</button>
        </div>
    </div>

    <div id="modalEdicion" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="cerrarModal()">&times;</span>
            <h2 data-i18n="titleEditar">Editar</h2>
            <div class="form-group"><input type="date" id="modalFecha"></div>
            <div class="form-group"><select id="modalCategoria"></select></div>
            <div class="form-group"><input type="text" id="modalDescripcion"></div>
            <div class="form-group"><input type="text" id="modalValor" inputmode="decimal"></div>
            <div class="payment-type-group">
                <input type="radio" id="modalPagoContado" name="modalTipoPago" value="Contado">
                <label for="modalPagoContado"><i class="fas fa-coins"></i> <span data-i18n="lblContado">Contado</span></label>
                <input type="radio" id="modalPagoTarjeta" name="modalTipoPago" value="Tarjeta">
                <label for="modalPagoTarjeta"><i class="far fa-credit-card"></i> <span data-i18n="lblTarjeta">Tarjeta</span></label>
                <input type="radio" id="modalPagoTransferencia" name="modalTipoPago" value="Transferencia">
                <label for="modalPagoTransferencia"><i class="fas fa-mobile-alt"></i> <span data-i18n="lblTransf">Transf.</span></label>
            </div>
            <div class="modal-botones-row">
                <button class="btn btn-success" onclick="guardarEdicionDesdeModal()" data-i18n="btnGuardar">Guardar</button>
                <button class="btn btn-danger" onclick="confirmarEliminarGasto()" data-i18n="btnBorrar">Borrar</button>
                <button class="btn btn-secondary" onclick="cerrarModal()" data-i18n="btnCancelar">Cancelar</button>
            </div>
        </div>
    </div>
    
    <div id="modalEdicionIngreso" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="cerrarModalEdicionIngreso()">&times;</span>
            <h2 data-i18n="titleEditarIngreso">Editar Ingreso</h2>
            <div class="form-group"><input type="date" id="modalFechaIngreso"></div>
            <div class="form-group"><input type="text" id="modalDescripcionIngreso"></div>
            <div class="form-group"><input type="text" id="modalValorIngreso" inputmode="decimal"></div>
            <div class="modal-botones-row">
                <button class="btn btn-success" onclick="guardarEdicionIngreso()" data-i18n="btnGuardar">Guardar</button>
                <button class="btn btn-danger" onclick="confirmarEliminarIngreso()" data-i18n="btnBorrar">Borrar</button>
                <button class="btn btn-secondary" onclick="cerrarModalEdicionIngreso()" data-i18n="btnCancelar">Cancelar</button>
            </div>
        </div>
    </div>
    
    <div id="modalEdicionCategoria" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="cerrarModalCategoria()">&times;</span>
            <h2 data-i18n="titleRenombrar">Editar Categor칤a</h2>
            <div class="form-group">
                <label data-i18n="lblNombreCat">Nombre:</label>
                <input type="text" id="modalCategoriaNombre">
                <div class="emoji-bar">
                    <button class="emoji-btn" onclick="insertarEmoji('游')">游</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游낁')">游낁</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游눠')">游눠</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游')">游</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游님')">游님</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游닜')">游닜</button>
                    
                    <button class="emoji-btn" onclick="insertarEmoji('游')">游</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游빜')">游빜</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游꽇勇')">游꽇勇</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游꼢')">游꼢</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游꼣')">游꼣</button>
                    <button class="emoji-btn" onclick="insertarEmoji('驕')">驕</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游띳')">游띳</button>
                    
                    <button class="emoji-btn" onclick="insertarEmoji('久')">久</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游뚱')">游뚱</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游뚧')">游뚧</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游뚢')">游뚢</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游뚯')">游뚯</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游댢')">游댢</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游勇')">游勇</button>
                    
                    <button class="emoji-btn" onclick="insertarEmoji('游녯')">游녯</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游')">游</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游눹')">游눹</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游꿚')">游꿚</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游꾸')">游꾸</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游눱')">游눱</button>
                    
                    <button class="emoji-btn" onclick="insertarEmoji('游낀')">游낀</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游눍')">游눍</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游뽘')">游뽘</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游끪勇꽥勇')">游끪勇꽥勇</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游꿉')">游꿉</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游닄')">游닄</button>
                    
                    <button class="emoji-btn" onclick="insertarEmoji('游꿡')">游꿡</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游꿟')">游꿟</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游꿧')">游꿧</button>
                    <button class="emoji-btn" onclick="insertarEmoji('九걾잺')">九걾잺</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游빕')">游빕</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游끴勇')">游끴勇</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游꿞')">游꿞</button>
                    
                    <button class="emoji-btn" onclick="insertarEmoji('游눯')">游눯</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游냥')">游냥</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游늳')">游늳</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游')">游</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游눺')">游눺</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游듹勇')">游듹勇</button>
                    
                    <button class="emoji-btn" onclick="insertarEmoji('游놌')">游놌</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游')">游</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游냤')">游냤</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游꿢')">游꿢</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游뱋')">游뱋</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游꿀')">游꿀</button>
                    <button class="emoji-btn" onclick="insertarEmoji('游닍')">游닍</button>
                </div>
            </div>
            <div class="form-group">
                <label data-i18n="lblMetaMensual">Meta Mensual ($):</label>
                <input type="number" id="modalCategoriaPresupuesto" placeholder="0 (Sin l칤mite)" inputmode="decimal">
            </div>
            <div class="modal-botones-row">
                <button class="btn btn-success" onclick="guardarEdicionCategoria()" data-i18n="btnGuardar">Guardar</button>
                <button class="btn btn-secondary" onclick="cerrarModalCategoria()" data-i18n="btnCancelar">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="modalSeleccionMoneda" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('modalSeleccionMoneda').style.display='none'">&times;</span>
            <h3 data-i18n="lblMoneda">Moneda</h3>
            <ul class="option-list">
                <li class="option-item" data-val="$" onclick="cambiarMoneda('$')"><span>$ D칩lar (USD)</span> <i class="fas fa-check option-check"></i></li>
                <li class="option-item" data-val="" onclick="cambiarMoneda('')"><span> Euro</span> <i class="fas fa-check option-check"></i></li>
                <li class="option-item" data-val="MXN$" onclick="cambiarMoneda('MXN$')"><span>MXN$ Peso Mex</span> <i class="fas fa-check option-check"></i></li>
                <li class="option-item" data-val="S/" onclick="cambiarMoneda('S/')"><span>S/ Sol Peruano</span> <i class="fas fa-check option-check"></i></li>
                <li class="option-item" data-val="COL$" onclick="cambiarMoneda('COL$')"><span>COL$ Peso Col</span> <i class="fas fa-check option-check"></i></li>
                <li class="option-item" data-val="Bs." onclick="cambiarMoneda('Bs.')"><span>Bs. Boliviano</span> <i class="fas fa-check option-check"></i></li>
            </ul>
        </div>
    </div>

    <div id="modalSeleccionIdioma" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('modalSeleccionIdioma').style.display='none'">&times;</span>
            <h3 data-i18n="lblIdioma">Idioma</h3>
            <ul class="option-list">
                <li class="option-item" onclick="cambiarIdioma('es')"><span>游쀯릖 Espa침ol</span> <i class="fas fa-check option-check"></i></li>
                <li class="option-item" onclick="cambiarIdioma('en')"><span>游쥟릖 English</span> <i class="fas fa-check option-check"></i></li>
            </ul>
        </div>
    </div>
    
    <div id="modalConfirmacion" class="modal">
        <div class="modal-content">
            <h2 data-i18n="titleConfirmar">Confirmar</h2>
            <p id="modalConfirmBody" style="text-align: center; margin-bottom: 20px;"></p>
            <div class="modal-botones-row">
                <button class="btn btn-danger" onclick="ejecutarConfirmacion()" data-i18n="btnSi">S칤</button>
                <button class="btn btn-secondary" onclick="cerrarModalConfirmacion()" data-i18n="btnNo">No</button>
            </div>
        </div>
    </div>

    <div id="modalPinConfig" class="modal">
        <div class="modal-content">
            <h2 style="margin-top:0;">Crear PIN</h2>
            <p style="text-align:center; color:var(--secondary-color);">Ingresa 4 d칤gitos</p>
            <input type="tel" id="newPinInput" maxlength="4" style="font-size: 2em; letter-spacing: 10px; text-align: center; margin: 20px 0;">
            <div class="modal-botones-row">
                <button class="btn btn-primary" onclick="guardarNuevoPin()">Aceptar</button>
                <button class="btn btn-secondary" onclick="cancelarPin()">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="toast">Notificaci칩n</div>

    <div class="nav-tabs">
        <button onclick="mostrarPantalla('gasto', this)" class="active"><i class="fas fa-plus-circle"></i><span data-i18n="menuGasto">Gasto</span></button>
        <button onclick="mostrarPantalla('ingreso', this)"><i class="fas fa-money-bill-wave"></i><span data-i18n="menuIngreso">Ingreso</span></button>
        <button onclick="mostrarPantalla('mensual', this)"><i class="fas fa-chart-pie"></i><span data-i18n="menuMes">Mes</span></button>
        <button onclick="mostrarPantalla('historico', this)"><i class="fas fa-calendar-alt"></i><span data-i18n="menuAnio">A침o</span></button>
        <button onclick="mostrarPantalla('configuracion', this)">
            <i class="fas fa-cog"></i>
            <span data-i18n="menuConfig">Config</span>
            <div id="backupBadge" class="backup-dot"></div>
        </button>
    </div>

<script>
// --- CONFIG Y TRADUCCIONES ---
const MONTH_NAMES_FULL = { es: ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'], en: ['January','February','March','April','May','June','July','August','September','October','November','December'] };
const TRADUCTIONS = {
    es: { alertMissing:"Faltan campos.", alertGuardado:"춰Guardado!", alertMissingCat:"춰Seleccione una categor칤a!", confirmDelete:"쮼liminar?", confirmDeleteAll:"쮹ORRAR TODO?", alertNoExport:"Sin datos.", alertCSVEmpty:"Vac칤o.", alertImportSuccess:c=>`Importados ${c}.`, alertImportSuccessJSON:"춰Datos cargados!", alertImportErrorJSON:"Error archivo.", alertCatNombreExiste:n=>`"${n}" existe.`, alertCatNoSePuedeBorrar:n=>`"${n}" en uso.`, modalConfirmDeleteCat:n=>`쮹orrar "${n}"?`, toastGastoEliminado:"Eliminado.", toastCategoriaGuardada:"Guardada.", toastCategoriaEliminada:"Eliminada.", appTitle:"Control de Gastos", titleIngresoGasto:"Ingreso de Gasto", lblFecha:"Fecha:", lblCategoria:"Categor칤a:", lblDescripcion:"Descripci칩n:", phEjCafe:"Ej: Caf칠", lblValor:"Valor:", lblTipoPago:"Pago:", lblContado:"Efectivo", lblTarjeta:"Tarjeta", lblTransf:"Transf.", btnAddGasto:"俱", titleGastosMes:"칔ltimos Gastos", lblClicEditar:"Clic para editar", colFecha:"Fecha", colDesc:"Descripci칩n", colValor:"Valor", lblTotal:"TOTAL", titleResumenMensual:"Resumen Mensual", titleTotalCategoria:"Total por Categor칤a", colTotal:"Total", colCategoria:"Categor칤a", titleDetalle:"Detalle", phBuscar:"Buscar...", lblTotalGeneral:"TOTAL GENERAL", btnAnterior:"Ant", btnSiguiente:"Sig", btnCsvMes:"Excel", titleResumenAnual:"Resumen Anual", titleTotalCatAnio:"Total A침o", btnCsvAnio:"Excel", menuConfig:"Config", lblMoneda:"Moneda:", lblIdioma:"Idioma:", titleCategorias:"Personaliza tus Categor칤as", colNombre:"Nombre", colMeta: "Meta ($)", colAccion:"Acci칩n", phNueva:"Nueva Categor칤a", titleDatos:"Gesti칩n de Datos", btnBackup:"Crear Copia de Seguridad", btnImportar:"Restaurar Datos", btnBorrarTodo:"Eliminar Todos los Datos", titleEditar:"Editar", btnGuardar:"Guardar", btnBorrar:"Borrar", btnCancelar:"Cancelar", titleRenombrar:"Editar Categor칤a", titleConfirmar:"Confirmar", btnSi:"S칤", btnNo:"No", menuGasto:"Gasto", menuMes:"Mes", menuAnio:"A침o", btnCargado:"춰Cargado!", msgGastoGuardado:"Gasto Guardado", btnVolver:"Volver", menuIngreso:"Ingreso", titleIngresoDinero:"Nuevo Ingreso", phDescIngreso:"Sueldo, Bono...", msgIngresoGuardado:"Ingreso Guardado", titleIngresosMes:"칔ltimos Ingresos", titleEditarIngreso:"Editar Ingreso", lblIngreso:"Ingreso", lblGasto:"Gasto", lblDisponible:"Disponible", lblDispCorto:"Disp:", lblFiltroPago:"Filtro por tipo de pago", lblVerTodos:"Todo", titleDetalleMensual:"Detalle Mensual", colMes:"Mes", colIngreso:"Ingreso", colSaldo:"Saldo", lblNombreCat:"Nombre:", lblMetaMensual:"Meta Mensual ($):", lblMeta:"Meta Mensual" },
    en: { alertMissing:"Missing fields.", alertGuardado:"Saved!", alertMissingCat:"Select category!", confirmDelete:"Delete?", confirmDeleteAll:"DELETE ALL?", alertNoExport:"No data.", alertCSVEmpty:"Empty.", alertImportSuccess:c=>`Imported ${c}.`, alertImportSuccessJSON:"Data Loaded!", alertImportErrorJSON:"Error.", alertCatNombreExiste:n=>`"${n}" exists.`, alertCatNoSePuedeBorrar:n=>`"${n}" used.`, modalConfirmDeleteCat:n=>`Delete "${n}"?`, toastGastoEliminado:"Deleted.", toastCategoriaGuardada:"Saved.", toastCategoriaEliminada:"Deleted.", appTitle:"Expense Tracker", titleIngresoGasto:"Add Expense", lblFecha:"Date:", lblCategoria:"Category:", lblDescripcion:"Description:", phEjCafe:"Ex: Coffee", lblValor:"Value:", lblTipoPago:"Payment:", lblContado:"Cash", lblTarjeta:"Card", lblTransf:"Transfer", btnAddGasto:"俱", titleGastosMes:"Recent Expenses", lblClicEditar:"Click to edit", colFecha:"Date", colDesc:"Description", colValor:"Value", lblTotal:"TOTAL", titleResumenMensual:"Monthly Summary", titleTotalCategoria:"Total by Category", colTotal:"Total", colCategoria:"Category", titleDetalle:"Detail", phBuscar:"Search...", lblTotalGeneral:"GRAND TOTAL", btnAnterior:"Prev", btnSiguiente:"Next", btnCsvMes:"Export", titleResumenAnual:"Annual Summary", titleTotalCatAnio:"Total Year", btnCsvAnio:"Export", menuConfig:"Config", lblMoneda:"Currency:", lblIdioma:"Language:", titleCategorias:"Customize Categories", colNombre:"Name", colMeta: "Goal ($)", colAccion:"Action", phNueva:"New Category", titleDatos:"Data", btnBackup:"拘勇 Backup", btnImportar:"拘勇 Import", btnBorrarTodo:"丘멆잺 Delete All", titleEditar:"Edit", btnGuardar:"Save", btnBorrar:"Delete", btnCancelar:"Cancel", titleRenombrar:"Edit Category", titleConfirmar:"Confirm", btnSi:"Yes", btnNo:"No", menuGasto:"Expense", menuMes:"Month", menuAnio:"Year", btnCargado:"Loaded!", msgGastoGuardado:"Saved", btnVolver:"Back", menuIngreso:"Income", titleIngresoDinero:"New Income", phDescIngreso:"Salary...", msgIngresoGuardado:"Saved", titleIngresosMes:"Recent Incomes", titleEditarIngreso:"Edit Income", lblIngreso:"Income", lblGasto:"Expense", lblDisponible:"Available", lblDispCorto:"Avail:", lblFiltroPago:"Filter Payment", lblVerTodos:"All", titleDetalleMensual:"Monthly Detail", colMes:"Month", colIngreso:"Income", colSaldo:"Balance", lblNombreCat:"Name:", lblMetaMensual:"Monthly Goal ($):", lblMeta:"Monthly Goal" }
};

// --- DICCIONARIO EMOJIS (AUTO-REPARACI칍N) ---
const EMOJI_MAP = {
    'comida': '游꼢', 'alimento': '游꼢', 'supermercado': '游', 'restaurante': '游꽇勇',
    'transporte': '游뚧', 'bus': '游뚧', 'taxi': '游뚯', 'gasolina': '久', 'auto': '游뚱',
    'hogar': '游', 'casa': '游', 'renta': '游댐', 'alquiler': '游댐', 'luz': '游눠', 'agua': '游눦', 'internet': '游깷',
    'salud': '游눍', 'medico': '游녿꽥뚯勇', 'farmacia': '游낀', 'deporte': '游끪勇꽥勇', 'gym': '游눩',
    'ocio': '游꿀', 'cine': '游꿟', 'juegos': '游꿡', 'fiesta': '游봅',
    'educacion': '游닄', 'escuela': '游꿉', 'curso': '游닇',
    'ropa': '游녯', 'vestido': '游녱', 'zapatos': '游',
    'otros': '游닍', 'regalo': '游꾸', 'donacion': '游뱋',
    'mascotas': '游냤', 'perro': '游냤', 'gato': '游냠'
};

// --- ESTADO ---
let gastos=[], ingresos=[], config={}, descripcionesUsadas=[], descripcionesIngresosUsadas=[], gastoEditandoId=null, ingresoEditandoId=null, categoriaEditandoNombreAntiguo=null, pinBuffer="", filtroPagoMensual='TODOS', filtroPagoHistorico='TODOS', filtroCategoriaHistorico='TODOS', anioSeleccionadoIngreso=new Date().getFullYear(), chartInstances={mensual:null, historico:null, historicoMeses:null, modal:null}, confirmCallback=null, toastTimeout=null, paginaActual=1, listaDetalleActual=[], listaParaMostrar=[], paginaActualGastosMes=1, paginaActualIngresosMes=1, smartValorInput="0", smartValorInputIngreso="0";
const ITEMS_PER_PAGE=12; const PALETA_COLORES=['#2563EB','#10B981','#F59E0B','#8B5CF6','#EC4899','#06B6D4','#64748B'];

// --- INICIO ---
document.addEventListener('DOMContentLoaded', () => {
    if(typeof ChartDataLabels !== 'undefined') Chart.register(ChartDataLabels);
    cargarDatos();
    verificarPinInicio();
    inicializarUI();
    inicializarListenerTecladoFisico();
    inicializarScrollCategoriasMouse();
    if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
});

function cargarDatos(){
    try{
        const def={
            moneda:'$', idioma:'es', 
            categorias:['游꼢 Comida','游뚧 Transporte','游 Hogar','游눍 Salud','游꿀 Ocio','游닍 Otros'], 
            presupuestos:{}, pin:null, fechaUltimoBackup:null
        };        
        const loaded=JSON.parse(localStorage.getItem('config_v2'));
        config=loaded?{...def,...loaded}:def;
        
        // REPARACI칍N DE EMERGENCIA: Si las categor칤as se borraron, restaurarlas
        if(!config.categorias || config.categorias.length === 0){
            config.categorias = def.categorias;
        }

        if(!config.presupuestos) config.presupuestos={};
        
        gastos=JSON.parse(localStorage.getItem('gastos_v2'))||[];
        ingresos=JSON.parse(localStorage.getItem('ingresos_v2'))||[];
        gastos.forEach(g=>{if(!g.tipoPago)g.tipoPago='Contado'});
        gastos.sort(sortData); ingresos.sort(sortData);
        
        repararCategorias();

        descripcionesUsadas=[...new Set(gastos.map(g=>g.descripcion))];
        descripcionesIngresosUsadas=[...new Set(ingresos.map(i=>i.descripcion))];
        
        // --- CORRECCI칍N CLAVE AQU칈 ---
        // Usamos 'if' para que NO falle si ya borraste los selectores viejos
        const selMoneda = document.getElementById('configMoneda');
        if(selMoneda) selMoneda.value = config.moneda;

        const selIdioma = document.getElementById('configIdioma');
        if(selIdioma) selIdioma.value = config.idioma;

        const toggle = document.getElementById('togglePin');
        if(toggle) toggle.checked = !!config.pin;
        
        establecerFechaHoy(); 
        
        // Renderizamos ambos Grids (Gasto y Config)
        actualizarSelectCategorias(); 
        renderizarTablaCategorias(); 
        renderizarCategoriasSmart(); 
        
        actualizarSugerenciasDescripciones(descripcionesUsadas);
        actualizarSugerenciasIngresos(descripcionesIngresosUsadas);
        renderizarSelectores();
        
        actualizarDisplayValor(); 
        actualizarDisplayValorIngreso();
        renderizarGastosDelMes(); 
        renderizarIngresosAnuales();
        actualizarResumenMensual(); 
        actualizarResumenHistorico(); 
        actualizarSaldoHeader();
        verificarRecordatorioBackup();
        
        // Actualizamos las nuevas tarjetas
        if(typeof actualizarCardsConfig === 'function') actualizarCardsConfig();
        
    }catch(e){
        console.error("Error en cargarDatos:", e);
    }
}

// --- NUEVA FUNCI칍N DE AUTO-REPARACI칍N ---
function repararCategorias() {
    let changed = false;
    config.categorias = config.categorias.map(cat => {
        if (cat.match(/^[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]/u)) return cat;
        const cleanName = cat.toLowerCase().trim();
        let icon = '游낑勇';
        for (const [key, emoji] of Object.entries(EMOJI_MAP)) {
            if (cleanName.includes(key)) { icon = emoji; break; }
        }
        const newName = `${icon} ${cat}`;
        gastos.forEach(g => { if(g.categoria === cat) g.categoria = newName; });
        if(config.presupuestos[cat]) {
            config.presupuestos[newName] = config.presupuestos[cat];
            delete config.presupuestos[cat];
        }
        changed = true;
        return newName;
    });

    if(changed) {
        localStorage.setItem('config_v2', JSON.stringify(config));
        guardarGastos();
    }
}

// --- LOGICA SELECTORES UNIFICADA ---
function renderizarSelectores() {
    const sm = document.getElementById('filtroMes');
    if (sm) {
        const val = sm.value || (new Date().getMonth() + 1);
        sm.innerHTML = '';
        MONTH_NAMES_FULL[config.idioma].forEach((m, i) => sm.add(new Option(m, i + 1)));
        sm.value = val;
    }
    const sa = document.getElementById('filtroAnioMensual');
    const sh = document.getElementById('filtroAnioHistorico');
    if (sa && sh) {
        const valA = sa.value || new Date().getFullYear();
        const valH = sh.value || new Date().getFullYear();
        sa.innerHTML = ''; sh.innerHTML = '';
        
        // 1. Recolectar a침os existentes en datos
        const existingYears = new Set();
        const currentYear = new Date().getFullYear();
        existingYears.add(currentYear);
        gastos.forEach(g => existingYears.add(parseInt(g.fecha.split('-')[0])));
        ingresos.forEach(i => existingYears.add(parseInt(i.fecha.split('-')[0])));

        // 2. Determinar rango (M칤nimo de datos vs L칤mite 2030)
        const minYear = Math.min(...existingYears);
        const maxYear = 2030; // L칤mite solicitado

        // 3. Generar lista descendente
        const finalYears = [];
        for (let y = maxYear; y >= minYear; y--) {
            finalYears.push(y);
        }
        
        // 4. Llenar selects
        finalYears.forEach(y => { sa.add(new Option(y, y)); sh.add(new Option(y, y)); });
        
        // 5. Mantener selecci칩n
        if (finalYears.includes(parseInt(valA))) sa.value = valA;
        if (finalYears.includes(parseInt(valH))) sh.value = valH;
    }
}

// --- LOGICA ---
function verificarPinInicio(){ if(config.pin){ document.getElementById('lockScreen').style.display='flex'; pinBuffer=""; actualizarPinDisplay(); } }
function ingresarPin(d){ if(d==='back') pinBuffer=pinBuffer.slice(0,-1); else if(pinBuffer.length<4) pinBuffer+=d; actualizarPinDisplay(); }
function actualizarPinDisplay(){ document.getElementById('pinDisplay').textContent="".repeat(pinBuffer.length); document.getElementById('pinError').style.display='none'; }
function verificarPin(){ if(pinBuffer===config.pin){ document.getElementById('lockScreen').style.display='none'; pinBuffer=""; } else { document.getElementById('pinError').style.display='block'; pinBuffer=""; setTimeout(actualizarPinDisplay,500); navigator.vibrate?.(200); } }
function toggleSeguridad(el){ if(el.checked){ document.getElementById('modalPinConfig').style.display='block'; document.getElementById('newPinInput').value=''; document.getElementById('newPinInput').focus(); } else { config.pin=null; localStorage.setItem('config_v2',JSON.stringify(config)); mostrarToast("PIN Desactivado","success"); actualizarCardsConfig();} }
function guardarNuevoPin(){ const p=document.getElementById('newPinInput').value; if(p.length===4&&!isNaN(p)){ config.pin=p; localStorage.setItem('config_v2',JSON.stringify(config)); document.getElementById('modalPinConfig').style.display='none'; mostrarToast("PIN Activado","success"); actualizarCardsConfig();} else alert("PIN de 4 d칤gitos"); }
function cancelarPin(){ document.getElementById('modalPinConfig').style.display='none'; document.getElementById('togglePin').checked=false; }
function verificarRecordatorioBackup(){ if(!config.fechaUltimoBackup){ document.getElementById('backupBadge').style.display='block'; return; } const diff=Math.ceil(Math.abs(new Date()-new Date(config.fechaUltimoBackup))/(1000*60*60*24)); document.getElementById('backupBadge').style.display=(diff>7)?'block':'none'; }
function insertarEmoji(e){ const i=document.getElementById('modalCategoriaNombre'); i.value=e+" "+i.value; i.focus(); }

function inicializarUI(){ 
    mostrarPantalla('gasto',document.querySelector('.nav-tabs button.active')); 

    // Listener para el campo de Gasto
    const d=document.getElementById('gastoDescripcion'); 
    if(d){ 
        d.addEventListener('focus', () => {
            document.getElementById('keypadContainer').style.display='none';
            ocultarConfirmaciones(); // <--- OCULTAR AL ESCRIBIR
        }); 
        d.addEventListener('blur',()=>{setTimeout(()=>{document.getElementById('keypadContainer').style.display='block'},150)});
        d.addEventListener('input', predecirCategoria);
    } 

    // Listener para el campo de Ingreso (si existe)
    const di = document.getElementById('ingresoDescripcion');
    if(di){
        di.addEventListener('focus', () => ocultarConfirmaciones()); // <--- OCULTAR AL ESCRIBIR
    }

    window.onclick=(e)=>{ 
        if(e.target.className==='modal'||e.target.className==='close-btn') { document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); } 
        const g=document.getElementById('smartCategories'); 
        const c=e.target.closest('.smart-cat-grid')||e.target.closest('.cat-btn')||e.target.closest('#gastoDescripcion'); 
        if(!c&&g){ if(document.getElementById('gastoCategoria').value!==""||document.getElementById('gastoDescripcion').value.trim().length>0) g.classList.remove('expanded'); } 
    }; 

    const f=document.getElementById('inputImportar'); if(f) f.addEventListener('change',importarDatos); 
    document.querySelectorAll('input[name="filtroTipoPagoMensual"]').forEach(r=>{r.addEventListener('change',(e)=>{filtroPagoMensual=e.target.value;actualizarResumenMensual()})}); 
    document.querySelectorAll('input[name="filtroTipoPagoHistorico"]').forEach(r=>{r.addEventListener('change',(e)=>{filtroPagoHistorico=e.target.value;actualizarResumenHistorico(true)})}); 
}

function actualizarSaldoHeader(){ const m=new Date().getMonth()+1, a=new Date().getFullYear(); const i=ingresos.filter(x=>{const[y,mm]=x.fecha.split('-');return parseInt(y)==a&&parseInt(mm)==m}).reduce((s,x)=>s+Number(x.valor),0); const g=gastos.filter(x=>{const[y,mm]=x.fecha.split('-');return parseInt(y)==a&&parseInt(mm)==m}).reduce((s,x)=>s+Number(x.valor),0); const s=i-g; const el=document.getElementById('headerSaldoValor'); el.textContent=formatearMoneda(s); const p=(i>0)?(s/i)*100:(s>=0?100:-1); el.style.color=(s<0||p<10)?'#FCA5A5':(p<30?'#FCD34D':'#6EE7B7'); }
function cambiarAnioIngreso(d){ anioSeleccionadoIngreso+=d; document.getElementById('displayAnioIngreso').textContent=anioSeleccionadoIngreso; paginaActualIngresosMes=1; renderizarIngresosAnuales(); }
function agregarGasto(){ 
    const f=document.getElementById('gastoFecha').value;
    const c=document.getElementById('gastoCategoria').value;
    const d=sanitizar(document.getElementById('gastoDescripcion').value.trim());
    const v=parsearValor(document.getElementById('gastoValor').value);
    const p=document.querySelector('input[name="tipoPago"]:checked').value; 
    
    if(!c) return mostrarToast(TRADUCTIONS[config.idioma].alertMissingCat,'error'); 
    if(!f||!d||isNaN(v)||v<=0) return mostrarToast(TRADUCTIONS[config.idioma].alertMissing,'error'); 
    
    gastos.push({id:Date.now(),fecha:f,categoria:c,descripcion:d,valor:v,tipoPago:p}); 
    gastos.sort(sortData); 
    guardarGastos(); 

    // --- NUEVO FORMATO DE CONFIRMACI칍N (UNA L칈NEA) ---
    // Ej: "Guardado: Almuerzo... $4.50"
    const textoCorto = `九 Guardado: ${d}  ${formatearMoneda(v)}`;
    document.getElementById('feedbackTexto').textContent = textoCorto; 
    document.getElementById('feedbackUltimoGasto').style.display = 'flex'; 
    // --------------------------------------------------

    document.getElementById('gastoDescripcion').value=''; 
    document.getElementById('gastoCategoria').value=''; 
    smartValorInput="0"; 
    actualizarDisplayValor(); 
    renderizarCategoriasSmart(null); 
    document.getElementById('budgetProgressContainer').style.display='none'; 
    renderizarSelectores(); 
    renderizarGastosDelMes(); 
    actualizarResumenMensual(); 
    actualizarResumenHistorico(); 
    actualizarSaldoHeader(); 
}

function agregarIngreso(){ 
    const f=document.getElementById('ingresoFecha').value;
    const d=sanitizar(document.getElementById('ingresoDescripcion').value.trim());
    const v=parsearValor(document.getElementById('ingresoValor').value); 
    
    if(!f||!d||isNaN(v)||v<=0) return mostrarToast(TRADUCTIONS[config.idioma].alertMissing,'error'); 
    
    ingresos.push({id:Date.now(),fecha:f,descripcion:d,valor:v}); 
    ingresos.sort(sortData); 
    guardarIngresos(); 
    
    if(!descripcionesIngresosUsadas.includes(d)){
        descripcionesIngresosUsadas.push(d);
        actualizarSugerenciasIngresos(descripcionesIngresosUsadas);
    } 

    // --- NUEVO FORMATO DE CONFIRMACI칍N (UNA L칈NEA) ---
    const textoCorto = `九 Guardado: ${d}  ${formatearMoneda(v)}`;
    document.getElementById('feedbackTextoIngreso').textContent = textoCorto; 
    document.getElementById('feedbackUltimoIngreso').style.display = 'flex';
    // --------------------------------------------------

    document.getElementById('ingresoDescripcion').value=''; 
    smartValorInputIngreso="0"; 
    actualizarDisplayValorIngreso(); 
    if(parseInt(f.split('-')[0])===anioSeleccionadoIngreso){
        paginaActualIngresosMes=1; 
        renderizarIngresosAnuales();
    } 
    actualizarSaldoHeader(); 
    renderizarSelectores(); 
    actualizarResumenMensual(); 
}    
// RESTAURADO AVISO ORIGINAL
    document.getElementById('feedbackTexto').textContent=`${c} - ${d}: ${formatearMoneda(v)}`; document.getElementById('feedbackUltimoGasto').style.display='flex'; 
    document.getElementById('gastoDescripcion').value=''; document.getElementById('gastoCategoria').value=''; smartValorInput="0"; actualizarDisplayValor(); renderizarCategoriasSmart(null); document.getElementById('budgetProgressContainer').style.display='none'; renderizarSelectores(); renderizarGastosDelMes(); actualizarResumenMensual(); actualizarResumenHistorico(); actualizarSaldoHeader(); 
function agregarIngreso(){ 
    const f=document.getElementById('ingresoFecha').value;
    const d=sanitizar(document.getElementById('ingresoDescripcion').value.trim());
    const v=parsearValor(document.getElementById('ingresoValor').value); 
    
    if(!f||!d||isNaN(v)||v<=0) return mostrarToast(TRADUCTIONS[config.idioma].alertMissing,'error'); 
    
    ingresos.push({id:Date.now(),fecha:f,descripcion:d,valor:v}); 
    ingresos.sort(sortData); 
    guardarIngresos(); 
    
    if(!descripcionesIngresosUsadas.includes(d)){
        descripcionesIngresosUsadas.push(d);
        actualizarSugerenciasIngresos(descripcionesIngresosUsadas);
    } 

    // --- NUEVO FORMATO DE CONFIRMACI칍N (UNA L칈NEA) ---
    const textoCorto = `九 Guardado: ${d}  ${formatearMoneda(v)}`;
    document.getElementById('feedbackTextoIngreso').textContent = textoCorto; 
    document.getElementById('feedbackUltimoIngreso').style.display = 'flex';
    // --------------------------------------------------

    document.getElementById('ingresoDescripcion').value=''; 
    smartValorInputIngreso="0"; 
    actualizarDisplayValorIngreso(); 
    if(parseInt(f.split('-')[0])===anioSeleccionadoIngreso){
        paginaActualIngresosMes=1; 
        renderizarIngresosAnuales();
    } 
    actualizarSaldoHeader(); 
    renderizarSelectores(); 
    actualizarResumenMensual(); 
}
    // RESTAURADO AVISO ORIGINAL
    document.getElementById('feedbackTextoIngreso').textContent=`${d}: ${formatearMoneda(v)}`; document.getElementById('feedbackUltimoIngreso').style.display='flex';
    document.getElementById('ingresoDescripcion').value=''; smartValorInputIngreso="0"; actualizarDisplayValorIngreso(); if(parseInt(f.split('-')[0])===anioSeleccionadoIngreso){paginaActualIngresosMes=1; renderizarIngresosAnuales();} actualizarSaldoHeader(); renderizarSelectores(); actualizarResumenMensual(); 
function guardarIngresos(){ localStorage.setItem('ingresos_v2',JSON.stringify(ingresos)); descripcionesIngresosUsadas=[...new Set(ingresos.map(i=>i.descripcion))]; actualizarSugerenciasIngresos(descripcionesIngresosUsadas); }
function actualizarDisplayValorIngreso(){ 
    document.getElementById('smartValueDisplayIngreso').textContent=config.moneda+' '+smartValorInputIngreso; 
    document.getElementById('ingresoValor').value=smartValorInputIngreso; 
    // CURSOR SOLO SI ES 0 o VACIO
    const cursor = document.getElementById('cursorIngreso');
    if(smartValorInputIngreso === "0" || smartValorInputIngreso === "") cursor.style.display = 'inline-block';
    else cursor.style.display = 'none';
}
function abrirModalDetalle(cat,lista){ document.getElementById('modalDetalleCategoriaTitulo').textContent=cat; listaDetalleActual=lista.filter(g=>g.categoria===cat); listaParaMostrar=[...listaDetalleActual]; paginaActual=1; document.getElementById('buscarDetalleModal').value=''; if(document.getElementById('historico').classList.contains('activa')){document.getElementById('modalChartContainer').style.display='block'; renderModalChart(cat,lista);}else{document.getElementById('modalChartContainer').style.display='none';} renderizarTablaDetallePaginada(); document.getElementById('modalDetalleGastos').style.display='block'; }
function renderModalChart(cat,lista){ const ctx=document.getElementById('modalChartCanvas').getContext('2d'); const y=document.getElementById('filtroAnioHistorico').value; const data=Array(12).fill(0); lista.filter(g=>g.categoria===cat).forEach(g=>{const m=parseInt(g.fecha.split('-')[1])-1;if(m>=0&&m<12)data[m]+=Number(g.valor)}); if(chartInstances.modal) chartInstances.modal.destroy(); chartInstances.modal=new Chart(ctx,{type:'bar',data:{labels:MONTH_NAMES_FULL[config.idioma].map(m=>m.substr(0,3)),datasets:[{data:data,backgroundColor:'#2563EB',borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},datalabels:{display:false},title:{display:true,text:`${cat} - ${y}`,font:{size:14}}},scales:{y:{display:false,grid:{display:false}},x:{grid:{display:false}}}}}); }
function cerrarModalDetalle(){ document.getElementById('modalDetalleGastos').style.display='none'; }
function abrirModalTablaAnual(){ document.getElementById('modalTablaAnual').style.display='block'; }
function cerrarModalTablaAnual(){ document.getElementById('modalTablaAnual').style.display='none'; }
function filtrarTablaDetalle(){ const t=document.getElementById('buscarDetalleModal').value.toLowerCase().trim(); listaParaMostrar=t===''?listaDetalleActual:listaDetalleActual.filter(g=>g.descripcion.toLowerCase().includes(t)||g.fecha.includes(t)||g.valor.toString().includes(t)); paginaActual=1; renderizarTablaDetallePaginada(); }
function cambiarPagina(d){ const t=Math.ceil(listaParaMostrar.length/ITEMS_PER_PAGE); const n=paginaActual+d; if(n>=1&&n<=t){ paginaActual=n; renderizarTablaDetallePaginada(); } }
function renderizarTablaDetallePaginada(){ const tb=document.querySelector('#tablaDetalleModal tbody'); tb.innerHTML=''; const i=(paginaActual-1)*ITEMS_PER_PAGE; const p=listaParaMostrar.slice(i,i+ITEMS_PER_PAGE); let tot=0; listaParaMostrar.forEach(g=>tot+=Number(g.valor)); p.forEach(g=>{const tr=document.createElement('tr'); tr.onclick=()=>{cerrarModalDetalle();abrirModalEdicion(g.id)}; const[y,m,d]=g.fecha.split('-'); tr.innerHTML=`<td>${d}/${m}</td><td>${g.descripcion}</td><td class="gasto-valor">${formatearMoneda(g.valor)}</td>`; tb.appendChild(tr);}); document.getElementById('totalDetalleModal').textContent=formatearMoneda(tot); const tp=Math.ceil(listaParaMostrar.length/ITEMS_PER_PAGE)||1; const c=document.getElementById('paginacionDetalleModal'); c.style.display=(tp<=1)?'none':'flex'; document.getElementById('pageInfoModal').textContent=`P치g ${paginaActual}/${tp} (${listaParaMostrar.length})`; }
function renderizarGastosDelMes(){ const tb=document.querySelector('#tablaUltimosGastos tbody'); if(!tb)return; tb.innerHTML=''; const h=new Date(); const l=gastos.filter(g=>{const[y,m]=g.fecha.split('-'); return parseInt(m)===(h.getMonth()+1)&&parseInt(y)===h.getFullYear()}); if(l.length===0){document.getElementById('emptyStateGasto').style.display='block'; document.getElementById('contenedorUltimosGastos').style.display='none'; document.getElementById('btnToggleGastos').style.display='none'; return;} else {document.getElementById('emptyStateGasto').style.display='none'; document.getElementById('btnToggleGastos').style.display='block';} let tot=0; l.forEach(g=>tot+=Number(g.valor)); document.getElementById('totalUltimosGastos').textContent=formatearMoneda(tot); const tp=Math.ceil(l.length/ITEMS_PER_PAGE)||1; if(paginaActualGastosMes>tp) paginaActualGastosMes=tp; if(paginaActualGastosMes<1) paginaActualGastosMes=1; const p=l.slice((paginaActualGastosMes-1)*ITEMS_PER_PAGE,paginaActualGastosMes*ITEMS_PER_PAGE); p.forEach(g=>{const tr=document.createElement('tr'); tr.onclick=()=>abrirModalEdicion(g.id); const[y,m,d]=g.fecha.split('-'); tr.innerHTML=`<td>${d}/${m}</td><td>${g.descripcion}<div class="gasto-categoria-subtexto">${g.categoria}</div></td><td class="gasto-valor">${formatearMoneda(g.valor)}</td>`; tb.appendChild(tr);}); const pi=document.getElementById('pageInfoPrincipal'); if(pi){pi.textContent=`P치g ${paginaActualGastosMes}/${tp}`; pi.parentElement.style.display=(tp<=1)?'none':'flex';} }
function cambiarPaginaPrincipal(d){ const h=new Date(); const l=gastos.filter(g=>{const[y,m]=g.fecha.split('-');return parseInt(m)===(h.getMonth()+1)&&parseInt(y)===h.getFullYear()}); const tp=Math.ceil(l.length/ITEMS_PER_PAGE); const n=paginaActualGastosMes+d; if(n>=1&&n<=tp){ paginaActualGastosMes=n; renderizarGastosDelMes(); } }
function renderizarIngresosAnuales(){ const tb=document.querySelector('#tablaUltimosIngresos tbody'); if(!tb)return; tb.innerHTML=''; const l=ingresos.filter(g=>parseInt(g.fecha.split('-')[0])===anioSeleccionadoIngreso); if(l.length===0){ document.getElementById('emptyStateIngreso').style.display='block'; document.getElementById('contenedorUltimosIngresos').style.display='none'; document.getElementById('btnToggleIngresos').style.display='none'; const ys=document.querySelector('#contenedorUltimosIngresos .year-selector-container'); if(ys){document.getElementById('ingreso').insertBefore(ys, document.getElementById('emptyStateIngreso')); ys.style.display='flex';} } else { document.getElementById('emptyStateIngreso').style.display='none'; document.getElementById('contenedorUltimosIngresos').style.display='block'; document.getElementById('btnToggleIngresos').style.display='block'; const ys=document.querySelector('.year-selector-container'); document.getElementById('contenedorUltimosIngresos').prepend(ys); } let tot=0; l.forEach(g=>tot+=Number(g.valor)); document.getElementById('totalUltimosIngresos').textContent=formatearMoneda(tot); const tp=Math.ceil(l.length/ITEMS_PER_PAGE)||1; if(paginaActualIngresosMes>tp) paginaActualIngresosMes=tp; if(paginaActualIngresosMes<1) paginaActualIngresosMes=1; const p=l.slice((paginaActualIngresosMes-1)*ITEMS_PER_PAGE,paginaActualIngresosMes*ITEMS_PER_PAGE); p.forEach(g=>{const tr=document.createElement('tr'); tr.onclick=()=>abrirModalEdicionIngreso(g.id); const[y,m,d]=g.fecha.split('-'); tr.innerHTML=`<td>${d}/${m}</td><td>${g.descripcion}</td><td class="gasto-valor">${formatearMoneda(g.valor)}</td>`; tb.appendChild(tr);}); const pi=document.getElementById('pageInfoIngresos'); if(pi){pi.textContent=`P치g ${paginaActualIngresosMes}/${tp}`; pi.parentElement.style.display=(tp<=1)?'none':'flex';} }
function cambiarPaginaIngresos(d){ const l=ingresos.filter(g=>parseInt(g.fecha.split('-')[0])===anioSeleccionadoIngreso); const tp=Math.ceil(l.length/ITEMS_PER_PAGE); const n=paginaActualIngresosMes+d; if(n>=1&&n<=tp){ paginaActualIngresosMes=n; renderizarIngresosAnuales(); } }

function actualizarResumenMensual(){ 
    const m=document.getElementById('filtroMes').value, a=document.getElementById('filtroAnioMensual').value; 
    const im=ingresos.filter(g=>{const[y,mm]=g.fecha.split('-');return parseInt(y)==a&&parseInt(mm)==m}); 
    const gm=gastos.filter(g=>{const[y,mm]=g.fecha.split('-');return parseInt(y)==a&&parseInt(mm)==m}); 
    const si=im.reduce((s,x)=>s+Number(x.valor),0); const sg=gm.reduce((s,x)=>s+Number(x.valor),0); 
    document.getElementById('dashIngreso').textContent=formatearMoneda(si); 
    document.getElementById('dashGasto').textContent=formatearMoneda(sg); 
    document.getElementById('dashBalance').textContent=formatearMoneda(si-sg); 
    renderizarResumenPresupuestos(gm); 
    
    let s = { t:0, c:0, tr:0, tf:0 };
    gm.forEach(g => {
        s.t += Number(g.valor);
        if(g.tipoPago=='Contado') s.c += Number(g.valor);
        if(g.tipoPago=='Tarjeta') s.tr += Number(g.valor);
        if(g.tipoPago=='Transferencia') s.tf += Number(g.valor);
    });
    if(document.getElementById('sum-contado-mensual')) {
        document.getElementById('sum-contado-mensual').textContent = formatearMoneda(s.c);
        document.getElementById('sum-tarjeta-mensual').textContent = formatearMoneda(s.tr);
        document.getElementById('sum-transf-mensual').textContent = formatearMoneda(s.tf);
    }

    let l=gm; 
    if(filtroPagoMensual!=='TODOS') l=l.filter(g=>g.tipoPago===filtroPagoMensual); 
    if(l.length===0){document.getElementById('emptyStateMensual').style.display='block'; document.getElementById('tablaResumenMensual').style.display='none'; document.getElementById('chartMensualContainer').style.display='none';} 
    else {document.getElementById('emptyStateMensual').style.display='none'; document.getElementById('tablaResumenMensual').style.display='table'; document.getElementById('chartMensualContainer').style.display='block'; renderizarTablaResumen(l,'tablaResumenMensual','totalResumenMensual'); actualizarGraficoCategorias(l,'chartMensualCanvas','mensual',`${MONTH_NAMES_FULL[config.idioma][m-1]} ${a}`);} 
}

function actualizarResumenHistorico(r){ 
    if(r)filtroCategoriaHistorico='TODOS'; 
    const a=document.getElementById('filtroAnioHistorico').value; 
    const ia=ingresos.filter(g=>g.fecha.startsWith(a)); 
    const ga=gastos.filter(g=>g.fecha.startsWith(a)); 
    const si=ia.reduce((s,x)=>s+Number(x.valor),0); 
    const sg=ga.reduce((s,x)=>s+Number(x.valor),0); 
    document.getElementById('dashIngresoHistorico').textContent=formatearMoneda(si); 
    document.getElementById('dashGastoHistorico').textContent=formatearMoneda(sg); 
    document.getElementById('dashBalanceHistorico').textContent=formatearMoneda(si-sg); 
    
    let s = { t:0, c:0, tr:0, tf:0 };
    ga.forEach(g => {
        s.t += Number(g.valor);
        if(g.tipoPago=='Contado') s.c += Number(g.valor);
        if(g.tipoPago=='Tarjeta') s.tr += Number(g.valor);
        if(g.tipoPago=='Transferencia') s.tf += Number(g.valor);
    });
    if(document.getElementById('sum-contado-historico')) {
        document.getElementById('sum-contado-historico').textContent = formatearMoneda(s.c);
        document.getElementById('sum-tarjeta-historico').textContent = formatearMoneda(s.tr);
        document.getElementById('sum-transf-historico').textContent = formatearMoneda(s.tf);
    }

    const da=Array(12).fill(0).map((_,i)=>({mesIndex:i,ingreso:0,gasto:0})); 
    ia.forEach(g=>da[parseInt(g.fecha.split('-')[1])-1].ingreso+=Number(g.valor)); 
    ga.forEach(g=>da[parseInt(g.fecha.split('-')[1])-1].gasto+=Number(g.valor)); 
    actualizarGraficoEvolucionAnual(da); renderizarTablaAnual(da); 
    
    let l=[...ga]; 
    if(filtroPagoHistorico!=='TODOS') l=l.filter(g=>g.tipoPago===filtroPagoHistorico); 
    renderizarTablaResumen(l,'tablaResumenHistorico','totalResumenHistorico'); 
    
    if(filtroCategoriaHistorico!=='TODOS') l=l.filter(g=>g.categoria===filtroCategoriaHistorico); 
    actualizarGraficoCategorias(l,'chartHistoricoCanvas','historico',`A침o ${a}`); 
}

function togglePresupuestos(){ const c=document.getElementById('budgetSummaryContainer'), ch=document.getElementById('budgetChevron'); if(c.style.display==='none'||c.style.display===''){c.style.display='block';ch.classList.replace('fa-chevron-down','fa-chevron-up')}else{c.style.display='none';ch.classList.replace('fa-chevron-up','fa-chevron-down')} }
function formatearMonedaSinDecimales(v){ return `${config.moneda} ${(v||0).toLocaleString('es-EC',{maximumFractionDigits:0})}`; }
function renderizarResumenPresupuestos(gm){ const c=document.getElementById('budgetSummaryContainer'); c.innerHTML=''; const pres=config.presupuestos||{}; const cats=Object.keys(pres); if(cats.length===0){c.innerHTML='<div style="text-align:center;font-size:0.8em;padding:10px;">Sin presupuestos.</div>';return;} cats.forEach(cat=>{const lim=pres[cat]; const gas=gm.filter(g=>g.categoria===cat).reduce((s,x)=>s+Number(x.valor),0); if(gas===0) return; const pct=(gas/lim)*100; let col='#6EE7B7'; if(pct>100)col='#FCA5A5'; else if(pct>70)col='#FCD34D'; c.innerHTML+=`<div class="budget-row"><div class="budget-row-header"><span>${cat}</span></div><div class="budget-visual-row"><div class="budget-list-track"><div class="budget-list-fill" style="width:${Math.min(pct,100)}%;background-color:${col};"></div></div><div class="budget-text-info">${formatearMonedaSinDecimales(gas)} / ${formatearMonedaSinDecimales(lim)} <strong>(${pct.toFixed(0)}%)</strong></div></div></div>`;}); }
function renderizarTablaAnual(da){ const tb=document.querySelector('#tablaDetalleAnual tbody'); tb.innerHTML=''; let ti=0,tg=0; da.forEach(d=>{const s=d.ingreso-d.gasto; if(d.ingreso===0&&d.gasto===0)return; ti+=d.ingreso; tg+=d.gasto; const tr=document.createElement('tr'); tr.innerHTML=`<td>${MONTH_NAMES_FULL[config.idioma][d.mesIndex].substring(0,3)}</td><td class="text-right gasto-valor">${formatearMoneda(d.ingreso)}</td><td class="text-right gasto-valor">${formatearMoneda(d.gasto)}</td><td class="text-right gasto-valor" style="color:${s<0?'#EF4444':''}">${formatearMoneda(s)}</td>`; tb.appendChild(tr);}); document.getElementById('totalAnualIngreso').textContent=formatearMoneda(ti); document.getElementById('totalAnualGasto').textContent=formatearMoneda(tg); const ts=ti-tg; const el=document.getElementById('totalAnualSaldo'); el.textContent=formatearMoneda(ts); el.style.color=ts<0?'#EF4444':''; }
function renderizarTablaResumen(l,id,tid){ const tb=document.querySelector(`#${id} tbody`); if(!tb)return; tb.innerHTML=''; const c={}; let t=0; l.forEach(g=>{c[g.categoria]=(c[g.categoria]||0)+Number(g.valor);t+=Number(g.valor)}); Object.entries(c).sort((a,b)=>b[1]-a[1]).forEach(([k,v])=>{const tr=document.createElement('tr'); const p=t>0?((v/t)*100).toFixed(1):'0.0'; tr.innerHTML=`<td>${k}</td><td class="gasto-valor">${formatearMoneda(v)}</td><td class="col-porcentaje">${p}%</td>`; tr.onclick=()=>abrirModalDetalle(k,l); tb.appendChild(tr);}); document.getElementById(tid).textContent=formatearMoneda(t); }
function tecladoPress(k){ 
    ocultarConfirmaciones(); // <--- AGREGAR ESTA L칈NEA AL INICIO

    const isI=document.getElementById('ingreso').classList.contains('activa'); 
    let v=isI?smartValorInputIngreso:smartValorInput; 

    if(k==='back') v=v.length>1?v.slice(0,-1):"0"; 
    else if(k==='.') {if(!v.includes('.'))v+='.'} 
    else {
        if(v.includes('.')){if(v.split('.')[1].length>=2)return} 
        if(v==="0")v=k; else if(v.length<10)v+=k;
    } 

    if(isI){smartValorInputIngreso=v;actualizarDisplayValorIngreso()}
    else{smartValorInput=v;actualizarDisplayValor()} 
}
function actualizarDisplayValor(){ 
    document.getElementById('smartValueDisplay').textContent=config.moneda+' '+smartValorInput; 
    document.getElementById('gastoValor').value=smartValorInput; 
    const cursor = document.getElementById('cursorGasto');
    if(smartValorInput === "0" || smartValorInput === "") cursor.style.display = 'inline-block';
    else cursor.style.display = 'none';
}
function predecirCategoria(){ 
    const input = document.getElementById('gastoDescripcion');
    const t = input.value.toLowerCase().trim();
    const c = document.getElementById('smartCategories');
    
    // 1. Limpieza si est치 vac칤o
    if(t.length<2){
        if(t.length===0){
            c.classList.add('expanded');
            document.getElementById('gastoCategoria').value="";
            renderizarCategoriasSmart(null);
        }
        return;
    } 

    // 2. Predicci칩n Visual (StartsWith) - Mantiene la categor칤a seleccionada visualmente mientras escribes
    const m = gastos.find(g => g.descripcion.toLowerCase().startsWith(t)); 
    if(m){ 
        seleccionarCategoriaSmart(m.categoria); 
        const b = c.getElementsByClassName('cat-btn'); 
        for(let btn of b){
            if(btn.textContent===m.categoria){
                btn.classList.add('flash');
                setTimeout(()=>btn.classList.remove('flash'),400);
                break;
            }
        } 
        c.classList.remove('expanded'); 
    } else {
        document.getElementById('gastoCategoria').value="";
        renderizarCategoriasSmart(null);
        c.classList.add('expanded');
    }
    
    // 3. NUEVO: Auto-cierre del teclado (Exact Match)
    // Si lo que hay escrito coincide EXACTAMENTE con un gasto previo (ej. al hacer clic en sugerencia)
    const exactMatch = gastos.find(g => g.descripcion.toLowerCase() === t);
    if(exactMatch) {
        seleccionarCategoriaSmart(exactMatch.categoria); // Asegurar categor칤a
        input.blur(); // ESTO OCULTA EL TECLADO NATIVO Y MUESTRA EL NUM칄RICO
    }
}
function seleccionarCategoriaSmart(cat){ document.getElementById('gastoCategoria').value=cat; renderizarCategoriasSmart(cat); const bc=document.getElementById('budgetProgressContainer'), bb=document.getElementById('budgetProgressBar'), bv=document.getElementById('budgetValue'); if(config.presupuestos&&config.presupuestos[cat]>0){const lim=config.presupuestos[cat]; const h=new Date(); const gm=gastos.filter(g=>{const[y,m]=g.fecha.split('-');return parseInt(y)===h.getFullYear()&&parseInt(m)===(h.getMonth()+1)&&g.categoria===cat}).reduce((s,x)=>s+Number(x.valor),0); const p=(gm/lim)*100; bc.style.display='block'; bv.textContent=`${formatearMoneda(gm)} / ${formatearMoneda(lim)}`; requestAnimationFrame(()=>{bb.style.width=Math.min(p,100)+'%'; bb.style.backgroundColor=p>100?'var(--danger-color)':(p>70?'var(--warning-color)':'var(--success-color)')});} else {bc.style.display='none';} document.getElementById('smartCategories').scrollLeft=0; }
function renderizarCategoriasSmart(s=null){ 
    const c=document.getElementById('smartCategories'); 
    c.innerHTML=''; 
    c.classList.remove('expanded'); 
    
    if(!s) s=document.getElementById('gastoCategoria').value; 
    
    // Frecuencia de uso para ordenar
    const f={}; 
    gastos.forEach(g=>f[g.categoria]=(f[g.categoria]||0)+1); 
    
    let co=[...config.categorias].sort((a,b)=>(f[b]||0)-(f[a]||0)); 
    
    // Si hay selecci칩n, ponerla primero
    if(s && co.includes(s)){ co=co.filter(x=>x!==s); co.unshift(s); } 
    
    co.forEach(cat=>{
        const b=document.createElement('div'); 
        b.className='cat-btn'; 
        if(cat===s) b.classList.add('selected'); 
        
        // L칩gica de separaci칩n Emoji/Texto (Igual que en Config)
        let emoji = cat.split(' ')[0]; 
        let nombre = cat.substring(emoji.length).trim();
        if(!nombre) { nombre = emoji; emoji = '游낑勇'; } // Fallback
        
        b.innerHTML=`
            <div class="cat-btn-icon">${emoji}</div>
            <div class="cat-btn-text">${nombre}</div>
        `; 
        
        b.onclick=()=>{ seleccionarCategoriaSmart(cat); c.classList.remove('expanded'); }; 
        c.appendChild(b);
    }); 
}
function toggleTablaGastos(){ const c=document.getElementById('contenedorUltimosGastos'), b=document.getElementById('btnToggleGastos'); if(c.style.display==='block'){c.style.display='none';b.innerHTML=`拘勇 ${TRADUCTIONS[config.idioma].titleGastosMes}`}else{c.style.display='block';b.innerHTML=`拘勇 ${TRADUCTIONS[config.idioma].titleGastosMes}`;setTimeout(()=>c.scrollIntoView({behavior:"smooth"}),100)} }
function toggleTablaIngresos(){ const c=document.getElementById('contenedorUltimosIngresos'), b=document.getElementById('btnToggleIngresos'); if(c.style.display==='block'){c.style.display='none';b.innerHTML=`拘勇 ${TRADUCTIONS[config.idioma].titleIngresosMes}`}else{c.style.display='block';b.innerHTML=`拘勇 ${TRADUCTIONS[config.idioma].titleIngresosMes}`;setTimeout(()=>c.scrollIntoView({behavior:"smooth"}),100)} }
function mostrarPantalla(id,btn){ ocultarConfirmaciones(); window.scrollTo(0,0); document.querySelectorAll('.pantalla').forEach(p=>p.classList.remove('activa')); document.getElementById(id).classList.add('activa'); document.querySelectorAll('.nav-tabs button').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); 
    document.getElementById('budgetSummaryContainer').style.display = 'none';
    document.getElementById('budgetChevron').classList.replace('fa-chevron-up', 'fa-chevron-down');
    if(id==='gasto'){paginaActualGastosMes=1;renderizarGastosDelMes();actualizarSaldoHeader()} if(id==='ingreso'){if(smartValorInputIngreso==="0")actualizarDisplayValorIngreso();paginaActualIngresosMes=1;renderizarIngresosAnuales();actualizarSaldoHeader()} if(id==='mensual'){actualizarResumenMensual()} if(id==='historico'){actualizarResumenHistorico()} }
function establecerFechaHoy(){ const h=new Date(); const s=`${h.getFullYear()}-${String(h.getMonth()+1).padStart(2,'0')}-${String(h.getDate()).padStart(2,'0')}`; document.getElementById('gastoFecha').value=s; document.getElementById('ingresoFecha').value=s; }
function cambiarFechaSmart(id){ document.getElementById(id).showPicker?document.getElementById(id).showPicker():document.getElementById(id).click(); }
document.getElementById('gastoFecha').addEventListener('change',e=>{const h=new Date(); const s=`${h.getFullYear()}-${String(h.getMonth()+1).padStart(2,'0')}-${String(h.getDate()).padStart(2,'0')}`; document.getElementById('smartFechaTexto').textContent=(e.target.value===s)?(config.idioma==='es'?'Hoy':'Today'):`${e.target.value.split('-')[2]}/${e.target.value.split('-')[1]}`});
document.getElementById('ingresoFecha').addEventListener('change',e=>{const h=new Date(); const s=`${h.getFullYear()}-${String(h.getMonth()+1).padStart(2,'0')}-${String(h.getDate()).padStart(2,'0')}`; document.getElementById('smartFechaIngresoTexto').textContent=(e.target.value===s)?(config.idioma==='es'?'Hoy':'Today'):`${e.target.value.split('-')[2]}/${e.target.value.split('-')[1]}`});
function aplicarIdioma(){ const t=TRADUCTIONS[config.idioma]; document.querySelectorAll('[data-i18n]').forEach(el=>el.textContent=t[el.getAttribute('data-i18n')]||el.textContent); document.querySelectorAll('[data-i18n-ph]').forEach(el=>el.placeholder=t[el.getAttribute('data-i18n-ph')]||el.placeholder); 
    renderizarSelectores();
}
function cambiarConfig(t,v){ config[t]=v; localStorage.setItem('config_v2',JSON.stringify(config)); (t==='moneda')?cargarDatos():aplicarIdioma(); }
function guardarGastos(){ localStorage.setItem('gastos_v2',JSON.stringify(gastos)); descripcionesUsadas=[...new Set(gastos.map(g=>g.descripcion))]; actualizarSugerenciasDescripciones(descripcionesUsadas); }
function sortData(a,b){ return new Date(b.fecha)-new Date(a.fecha)||b.id-a.id; }
function parsearValor(s){ return parseFloat(s?.toString().replace(',','.')||0); }
function formatearMoneda(v){ return `${config.moneda} ${(v||0).toLocaleString('es-EC',{minimumFractionDigits:2})}`; }
function mostrarToast(m,t){ const x=document.getElementById('toast'); x.textContent=m; x.className=`show ${t}`; clearTimeout(toastTimeout); toastTimeout=setTimeout(()=>x.className='',3000); }
function sanitizar(s){ if(!s)return''; const m={'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}; return s.replace(/[&<>"']/g,k=>m[k]); }
function inicializarListenerTecladoFisico(){ document.addEventListener('keydown',e=>{const g=document.getElementById('gasto').classList.contains('activa'), i=document.getElementById('ingreso').classList.contains('activa'); if((!g&&!i)||(e.target.tagName==='INPUT'&&e.target.type==='text'))return; if(e.key>='0'&&e.key<='9')tecladoPress(e.key); else if(e.key==='.'||e.key===',')tecladoPress('.'); else if(e.key==='Backspace')tecladoPress('back'); else if(e.key==='Enter'){e.preventDefault(); if(g)agregarGasto(); if(i)agregarIngreso();} }); }
function inicializarScrollCategoriasMouse(){const s=document.getElementById('smartCategories');s.addEventListener('wheel',e=>{if(!s.classList.contains('expanded')){e.preventDefault();s.scrollLeft+=e.deltaY}})}
function actualizarSugerenciasDescripciones(l){document.getElementById('sugerenciasDescripciones').innerHTML=l.map(d=>`<option value="${d}">`).join('');}
function actualizarSugerenciasIngresos(l){document.getElementById('sugerenciasIngresos').innerHTML=l.map(d=>`<option value="${d}">`).join('');}
async function compartirBackupJSON(){ const t=JSON.stringify({gastos_v2:gastos,ingresos_v2:ingresos,config_v2:config},null,2); const d=new Date(); config.fechaUltimoBackup=d.toISOString(); localStorage.setItem('config_v2',JSON.stringify(config)); verificarRecordatorioBackup(); const n=`Backup_${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}.txt`; const f=new File([new Blob([t],{type:'text/plain'})],n,{type:'text/plain'}); descargar(f); if(navigator.canShare&&navigator.canShare({files:[f]})){try{setTimeout(async()=>{await navigator.share({files:[f],title:'Backup'})},500)}catch{}} }
function descargar(f){ const a=document.createElement('a'); a.href=URL.createObjectURL(f); a.download=f.name; a.click(); }
function importarDatos(e){ const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=ev=>{try{const d=JSON.parse(ev.target.result); if(d.gastos_v2){localStorage.setItem('gastos_v2',JSON.stringify(d.gastos_v2)); localStorage.setItem('config_v2',JSON.stringify(d.config_v2)); if(d.ingresos_v2)localStorage.setItem('ingresos_v2',JSON.stringify(d.ingresos_v2)); mostrarToast(TRADUCTIONS[config.idioma].alertImportSuccessJSON,'success'); setTimeout(()=>location.reload(),1500);}}catch{mostrarToast(TRADUCTIONS[config.idioma].alertImportErrorJSON,'error')}}; r.readAsText(f); e.target.value=''; }
function confirmarLimpiarTodosLosDatos(){ mostrarModalConfirmacion(TRADUCTIONS[config.idioma].confirmDeleteAll,()=>{localStorage.clear();location.reload()}); }
function generarYCompartirCSV(t){ let n='',d=[],ti=''; if(t==='ingresos_mes'){const h=new Date(),m=h.getMonth()+1,a=h.getFullYear(); d=ingresos.filter(x=>{const[y,mm]=x.fecha.split('-');return parseInt(y)==a&&parseInt(mm)==m}); n=`Ingresos_${MONTH_NAMES_FULL[config.idioma][m-1]}_${a}`; ti=`Reporte Ingresos ${MONTH_NAMES_FULL[config.idioma][m-1]} ${a}`;} else if(t==='mensual'){const m=document.getElementById('filtroMes').value,a=document.getElementById('filtroAnioMensual').value; d=gastos.filter(x=>{const[y,mm]=x.fecha.split('-');return parseInt(y)==a&&parseInt(mm)==m}); n=`Gastos_${MONTH_NAMES_FULL[config.idioma][m-1]}_${a}`; ti=`Reporte ${MONTH_NAMES_FULL[config.idioma][m-1]} ${a}`;} else {const a=document.getElementById('filtroAnioHistorico').value; d=gastos.filter(g=>g.fecha.startsWith(a)); n=`Gastos_${a}`; ti=`Reporte ${a}`;} if(!d.length)return mostrarToast(TRADUCTIONS[config.idioma].alertNoExport,'error'); let c="\uFEFFFecha;Descripci칩n;Valor"; if(t!=='ingresos_mes')c+=";Categor칤a;TipoPago"; c+="\n"; d.forEach(g=>{let de=g.descripcion.replace(/;/g,","), v=g.valor.toString().replace('.',','); if(t==='ingresos_mes')c+=`${g.fecha};${de};${v}\n`; else c+=`${g.fecha};${de};${v};${g.categoria};${g.tipoPago}\n`;}); const f=new File([new Blob([c],{type:'text/csv;charset=utf-8;'})],`${n}.csv`,{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(f); a.download=f.name; a.click(); if(navigator.canShare&&navigator.canShare({files:[f]}))setTimeout(async()=>{try{await navigator.share({files:[f],title:'Control',text:ti})}catch{}},500); }
function generarPDF(t){ const{jsPDF}=window.jspdf; let d=[],ti='',cid=''; if(t==='ingresos_mes'){const h=new Date(),m=h.getMonth()+1,a=h.getFullYear(); d=ingresos.filter(g=>{const[y,mm]=g.fecha.split('-');return parseInt(y)==a&&parseInt(mm)==m}); ti=`Ingresos ${MONTH_NAMES_FULL[config.idioma][m-1]} ${a}`;} else if(t==='mensual'){const m=document.getElementById('filtroMes').value,a=document.getElementById('filtroAnioMensual').value; d=gastos.filter(g=>{const[y,mm]=g.fecha.split('-');return parseInt(y)==a&&parseInt(mm)==m}); ti=`Gastos ${MONTH_NAMES_FULL[config.idioma][m-1]} ${a}`; cid='chartMensualCanvas';} else {const a=document.getElementById('filtroAnioHistorico').value; d=gastos.filter(g=>g.fecha.startsWith(a)); ti=`Reporte Anual ${a}`; cid='chartHistoricoCanvas';} if(!d.length)return mostrarToast(TRADUCTIONS[config.idioma].alertNoExport,'error'); const doc=new jsPDF(); doc.setFontSize(18); doc.setTextColor(30,58,138); doc.text("Control de Gastos",14,20); doc.setFontSize(14); doc.setTextColor(100); doc.text(ti,14,30); let tot=0; d.forEach(g=>tot+=Number(g.valor)); doc.setFillColor(241,245,249); doc.rect(14,42,180,15,'F'); doc.setFontSize(12); doc.setTextColor(0); doc.text(`TOTAL: ${formatearMoneda(tot)}`,20,51); if(cid){const c=document.getElementById(cid); if(c){const i=c.toDataURL("image/png"); doc.addImage(i,'PNG',15,65,70,70)}} let h=[],b=[]; if(t==='ingresos_mes'){h=[['Fecha','Desc','Valor']]; b=d.map(g=>[g.fecha,g.descripcion,formatearMoneda(g.valor)])} else {h=[['Fecha','Cat','Desc','Valor','Pago']]; b=d.map(g=>[g.fecha,g.categoria,g.descripcion,formatearMoneda(g.valor),g.tipoPago])} doc.autoTable({startY:cid?145:65,head:h,body:b,theme:'grid',headStyles:{fillColor:[71,85,105]},styles:{fontSize:9},columnStyles:t==='ingresos_mes'?{2:{halign:'right'}}:{3:{halign:'right',cellWidth:40}}}); doc.save(`${ti.replace(/ /g,'_')}.pdf`); }
function abrirModalEdicion(id){ const g=gastos.find(x=>x.id===id); if(!g)return; gastoEditandoId=id; document.getElementById('modalFecha').value=g.fecha; document.getElementById('modalCategoria').value=g.categoria; document.getElementById('modalDescripcion').value=g.descripcion; document.getElementById('modalValor').value=g.valor; const r=document.getElementsByName('modalTipoPago'); for(const i of r)if(i.value===g.tipoPago)i.checked=true; document.getElementById('modalEdicion').style.display='block'; }
function cerrarModal(){ document.getElementById('modalEdicion').style.display='none'; gastoEditandoId=null; }
function guardarEdicionDesdeModal(){ const g=gastos.find(x=>x.id===gastoEditandoId); if(g){ g.fecha=document.getElementById('modalFecha').value; g.categoria=document.getElementById('modalCategoria').value; g.descripcion=sanitizar(document.getElementById('modalDescripcion').value); g.valor=parsearValor(document.getElementById('modalValor').value); g.tipoPago=document.querySelector('input[name="modalTipoPago"]:checked').value; gastos.sort(sortData); guardarGastos(); try{actualizarResumenMensual(); actualizarResumenHistorico(); renderizarGastosDelMes(); actualizarSaldoHeader();}catch(e){} cerrarModal(); } }
function confirmarEliminarGasto(){ mostrarModalConfirmacion(TRADUCTIONS[config.idioma].confirmDelete,()=>{ gastos=gastos.filter(g=>g.id!==gastoEditandoId); guardarGastos(); try{actualizarResumenMensual(); actualizarResumenHistorico(); renderizarGastosDelMes(); actualizarSaldoHeader();}catch(e){} cerrarModal(); }); }
function abrirModalEdicionIngreso(id){ const g=ingresos.find(x=>x.id===id); if(!g)return; ingresoEditandoId=id; document.getElementById('modalFechaIngreso').value=g.fecha; document.getElementById('modalDescripcionIngreso').value=g.descripcion; document.getElementById('modalValorIngreso').value=g.valor; document.getElementById('modalEdicionIngreso').style.display='block'; }
function cerrarModalEdicionIngreso(){ document.getElementById('modalEdicionIngreso').style.display='none'; ingresoEditandoId=null; }
function guardarEdicionIngreso(){ const g=ingresos.find(x=>x.id===ingresoEditandoId); if(g){ g.fecha=document.getElementById('modalFechaIngreso').value; g.descripcion=sanitizar(document.getElementById('modalDescripcionIngreso').value); g.valor=parsearValor(document.getElementById('modalValorIngreso').value); ingresos.sort(sortData); guardarIngresos(); try{renderizarIngresosAnuales(); actualizarSaldoHeader(); actualizarResumenMensual(); actualizarResumenHistorico();}catch(e){} cerrarModalEdicionIngreso(); } }
function confirmarEliminarIngreso(){ mostrarModalConfirmacion(TRADUCTIONS[config.idioma].confirmDelete,()=>{ ingresos=ingresos.filter(g=>g.id!==ingresoEditandoId); guardarIngresos(); try{renderizarIngresosAnuales(); actualizarSaldoHeader(); actualizarResumenMensual(); actualizarResumenHistorico();}catch(e){} cerrarModalEdicionIngreso(); }); }
function agregarCategoria(){ const n=sanitizar(document.getElementById('nuevaCategoria').value.trim()); if(!n)return; if(config.categorias.includes(n))return mostrarToast(TRADUCTIONS[config.idioma].alertCatNombreExiste(n),'error'); config.categorias.push(n); config.categorias.sort(); localStorage.setItem('config_v2',JSON.stringify(config)); document.getElementById('nuevaCategoria').value=''; actualizarSelectCategorias(); renderizarTablaCategorias(); renderizarCategoriasSmart(); }
function actualizarSelectCategorias(){ const s=config.categorias.map(c=>`<option value="${c}">${c}</option>`).join(''); document.getElementById('modalCategoria').innerHTML=s; }
function renderizarTablaCategorias(){ 
    const contenedor = document.getElementById('gridCategoriasConfig'); 
    if(!contenedor) return; 
    
    contenedor.innerHTML = ''; 
    
    // 1. Renderizar las categor칤as existentes
    config.categorias.forEach((c, i) => {
        let emoji = c.split(' ')[0]; 
        let nombre = c.substring(emoji.length).trim();
        if(!nombre) { nombre = emoji; emoji = '游낑勇'; }
        
        let metaHTML = ''; 
        let claseExtra = '';
        if(config.presupuestos && config.presupuestos[c] > 0){
            metaHTML = `<div class="config-meta">${formatearMonedaSinDecimales(config.presupuestos[c])}</div>`;
            claseExtra = 'has-budget'; 
        }
        
        const card = document.createElement('div');
        card.className = `config-cat-card ${claseExtra}`;
        card.onclick = () => abrirModalCategoria(i); // Modo Edici칩n
        
        card.innerHTML = `
            <div class="config-avatar">${emoji}</div>
            <div class="config-info">
                <div class="config-name">${nombre}</div>
                ${metaHTML}
            </div>
        `;
        contenedor.appendChild(card);
    });

    // 2. Renderizar la Tarjeta Especial "A칌ADIR NUEVA" al final
    const addCard = document.createElement('div');
    addCard.className = 'config-cat-card add-new';
    addCard.onclick = abrirModalNuevaCategoria; // Modo Creaci칩n
    addCard.innerHTML = `
        <div class="config-avatar"><i class="fas fa-plus"></i></div>
        <div class="config-name">Nueva Categor칤a</div>
    `;
    contenedor.appendChild(addCard);
}
// Abre el modal en modo "Crear" (limpio)
function abrirModalNuevaCategoria(){
    categoriaEditandoNombreAntiguo = null; // NULL indica que es nueva
    document.getElementById('modalCategoriaNombre').value = '';
    document.getElementById('modalCategoriaPresupuesto').value = '';
    
    // Ocultar bot칩n de borrar (no puedes borrar algo que no existe a칰n)
    const btnBorrar = document.getElementById('btnBorrarCategoriaModal');
    if(btnBorrar) btnBorrar.style.display = 'none';
    
    document.getElementById('modalEdicionCategoria').style.display = 'block';
    setTimeout(() => document.getElementById('modalCategoriaNombre').focus(), 100);
}
function abrirModalCategoria(i){ 
    categoriaEditandoNombreAntiguo = config.categorias[i]; 
    document.getElementById('modalCategoriaNombre').value = categoriaEditandoNombreAntiguo; 
    
    const p = (config.presupuestos && config.presupuestos[categoriaEditandoNombreAntiguo]) 
              ? config.presupuestos[categoriaEditandoNombreAntiguo] : ''; 
    document.getElementById('modalCategoriaPresupuesto').value = p; 
    
    // Mostrar bot칩n de borrar
    const btnBorrar = document.getElementById('btnBorrarCategoriaModal');
    if(btnBorrar) {
        btnBorrar.style.display = 'block';
        // Actualizamos el onclick para pasar el 칤ndice correcto
        btnBorrar.onclick = () => confirmarEliminarCategoria(i);
    }
    
    document.getElementById('modalEdicionCategoria').style.display = 'block'; 
}
function cerrarModalCategoria(){ document.getElementById('modalEdicionCategoria').style.display='none'; }
function guardarEdicionCategoria(){ 
    const n = sanitizar(document.getElementById('modalCategoriaNombre').value.trim()); 
    const p = parsearValor(document.getElementById('modalCategoriaPresupuesto').value); 
    
    if(!n) return mostrarToast(TRADUCTIONS[config.idioma].alertMissing, 'error');

    // CASO 1: ES UNA NUEVA CATEGOR칈A
    if(categoriaEditandoNombreAntiguo === null){
        if(config.categorias.includes(n)) return mostrarToast(TRADUCTIONS[config.idioma].alertCatNombreExiste(n),'error');
        config.categorias.push(n);
        config.categorias.sort();
        // Guardar presupuesto si se puso
        if(p > 0) {
            if(!config.presupuestos) config.presupuestos = {};
            config.presupuestos[n] = p;
        }
    } 
    // CASO 2: ES UNA EDICI칍N
    else {
        // Si cambi칩 el nombre, actualizamos referencias
        if(n !== categoriaEditandoNombreAntiguo){
            if(config.categorias.includes(n)) return mostrarToast(TRADUCTIONS[config.idioma].alertCatNombreExiste(n),'error');
            
            // Actualizar lista
            const idx = config.categorias.indexOf(categoriaEditandoNombreAntiguo);
            if(idx > -1) config.categorias[idx] = n;
            config.categorias.sort(); // Reordenar alfab칠ticamente
            
            // Actualizar gastos hist칩ricos
            gastos.forEach(g => { if(g.categoria === categoriaEditandoNombreAntiguo) g.categoria = n });
            
            // Migrar presupuesto al nuevo nombre
            if(config.presupuestos && config.presupuestos[categoriaEditandoNombreAntiguo]){
                config.presupuestos[n] = config.presupuestos[categoriaEditandoNombreAntiguo];
                delete config.presupuestos[categoriaEditandoNombreAntiguo];
            }
        }
        
        // Actualizar valor del presupuesto (para el nombre final 'n')
        if(!config.presupuestos) config.presupuestos = {};
        if(p > 0) config.presupuestos[n] = p;
        else delete config.presupuestos[n];
    }

    // Guardar todo y refrescar
    localStorage.setItem('config_v2', JSON.stringify(config)); 
    guardarGastos(); 
    
    renderizarTablaCategorias(); 
    renderizarCategoriasSmart(); 
    actualizarSelectCategorias(); 
    cerrarModalCategoria(); 
    
    mostrarToast("Categor칤a guardada", "success"); 
}
function confirmarEliminarCategoria(i){ const c=config.categorias[i]; if(gastos.some(g=>g.categoria===c))return mostrarToast(TRADUCTIONS[config.idioma].alertCatNoSePuedeBorrar(c),'error'); mostrarModalConfirmacion(TRADUCTIONS[config.idioma].modalConfirmDeleteCat(c),()=>{config.categorias.splice(i,1); if(config.presupuestos&&config.presupuestos[c])delete config.presupuestos[c]; localStorage.setItem('config_v2',JSON.stringify(config)); guardarGastos(); renderizarTablaCategorias(); renderizarCategoriasSmart(); actualizarSelectCategorias(); cerrarModalConfirmacion(); mostrarToast(TRADUCTIONS[config.idioma].toastCategoriaEliminada,"success");}); }
function mostrarModalConfirmacion(t,c){ document.getElementById('modalConfirmBody').textContent=t; confirmCallback=c; document.getElementById('modalConfirmacion').style.display='block'; }
function ejecutarConfirmacion(){ if(confirmCallback){try{confirmCallback()}catch(e){console.error(e)}} cerrarModalConfirmacion(); }
function cerrarModalConfirmacion(){ document.getElementById('modalConfirmacion').style.display='none'; }
function inicializarSelectoresMesAnio(){ const sm=document.getElementById('filtroMes'), sa=document.getElementById('filtroAnioMensual'), sh=document.getElementById('filtroAnioHistorico'); if(!sm||!sa||!sh)return; sm.innerHTML=''; sa.innerHTML=''; sh.innerHTML=''; const d=gastos.map(g=>parseInt(g.fecha.split('-')[0])); const c=new Date().getFullYear(); const min=d.length?Math.min(...d,c):c; const max=Math.max(...d,2030); for(let y=max;y>=min;y--){sa.add(new Option(y,y)); sh.add(new Option(y,y));} MONTH_NAMES_FULL[config.idioma].forEach((m,i)=>sm.add(new Option(m,i+1))); const h=new Date(); sm.value=h.getMonth()+1; sa.value=h.getFullYear(); sh.value=h.getFullYear(); }
function actualizarGraficoCategorias(l,c,k,t=''){ const ctx=document.getElementById(c).getContext('2d'); const d={}; let tot=0; l.forEach(g=>{d[g.categoria]=(d[g.categoria]||0)+Number(g.valor);tot+=Number(g.valor)}); if(chartInstances[k]) chartInstances[k].destroy(); chartInstances[k]=new Chart(ctx,{type:'doughnut',data:{labels:Object.keys(d),datasets:[{data:Object.values(d),backgroundColor:PALETA_COLORES,borderWidth:1}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},datalabels:{color:'white',font:{weight:'bold',size:12},display:ctx=>(ctx.dataset.data[ctx.dataIndex]/tot)>0.04,formatter:v=>(v*100/tot).toFixed(0)+"%"},title:{display:!!t,text:t,font:{size:14}}}}}); }
function actualizarGraficoEvolucionAnual(da){ const ctx=document.getElementById('chartHistoricoMesesCanvas').getContext('2d'); const i=da.map(d=>d.ingreso), g=da.map(d=>d.gasto); if(chartInstances.historicoMeses) chartInstances.historicoMeses.destroy(); chartInstances.historicoMeses=new Chart(ctx,{type:'bar',data:{labels:MONTH_NAMES_FULL[config.idioma].map(m=>m.substr(0,3)),datasets:[{label:'Ingreso',data:i,backgroundColor:'#2563EB',borderRadius:4},{label:'Gasto',data:g,backgroundColor:'#F87171',borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},datalabels:{display:false}},scales:{x:{grid:{display:false}},y:{beginAtZero:true,grid:{color:'#f0f0f0'}}}}}); }
// --- NUEVAS FUNCIONES PARA CONFIGURACI칍N VISUAL ---

function actualizarCardsConfig(){
    // 1. Actualizar Tarjeta Moneda
    const dispMoneda = document.getElementById('displayMonedaCard');
    if(dispMoneda) dispMoneda.textContent = config.moneda;
    
    // 2. Actualizar Tarjeta Idioma
    const dispIdioma = document.getElementById('displayIdiomaCard');
    if(dispIdioma) dispIdioma.textContent = config.idioma.toUpperCase();
    
    // 3. Actualizar Icono PIN
    const lockIcon = document.getElementById('iconLockState');
    if(lockIcon) {
        if(config.pin) {
            lockIcon.style.color = 'var(--success-color)'; // Verde si est치 activo
            lockIcon.className = 'fas fa-lock mini-card-icon';
        } else {
            lockIcon.style.color = 'var(--secondary-color)'; // Gris si est치 inactivo
            lockIcon.className = 'fas fa-lock-open mini-card-icon';
        }
    }
}

// Helper para activar el switch del PIN al tocar la tarjeta entera
function triggerTogglePin(e){
    // Evitamos doble disparo si se toca directamente el switch
    if(e.target.tagName !== 'INPUT' && e.target.className !== 'slider'){
        document.getElementById('togglePin').click();
    }
}


// --- L칍GICA MODAL MONEDA (CORREGIDA) ---
function abrirModalMoneda(){
    const modal = document.getElementById('modalSeleccionMoneda');
    modal.style.display='block';
    
    // Resaltar la opci칩n seleccionada actualmente
    const items = modal.querySelectorAll('.option-item');
    items.forEach(item => {
        item.classList.remove('selected');
        // AHORA COMPARAMOS EXACTAMENTE EL VALOR (data-val)
        if(item.getAttribute('data-val') === config.moneda){
            item.classList.add('selected');
        }
    });
}

function cambiarMoneda(nuevaMoneda){
    config.moneda = nuevaMoneda;
    localStorage.setItem('config_v2', JSON.stringify(config));
    
    // Cerrar modal y refrescar todo
    document.getElementById('modalSeleccionMoneda').style.display='none';
    cargarDatos(); // Recarga la app para aplicar el s칤mbolo en todos lados
    mostrarToast("Moneda actualizada", "success");
}

// --- L칍GICA MODAL IDIOMA ---
function abrirModalIdioma(){
    const modal = document.getElementById('modalSeleccionIdioma');
    modal.style.display='block';
    
    // Resaltar selecci칩n
    const codigoBusqueda = config.idioma === 'es' ? 'Espa침ol' : 'English';
    const items = modal.querySelectorAll('.option-item');
    items.forEach(item => {
        item.classList.remove('selected');
        if(item.textContent.includes(codigoBusqueda)){
            item.classList.add('selected');
        }
    });
}

function cambiarIdioma(nuevoIdioma){
    config.idioma = nuevoIdioma;
    localStorage.setItem('config_v2', JSON.stringify(config));
    
    // Aplicar cambios
    aplicarIdioma(); 
    document.getElementById('modalSeleccionIdioma').style.display='none';
    actualizarCardsConfig(); // Actualizar la tarjetita "ES/EN"
    mostrarToast("Idioma actualizado", "success");
}

function ocultarConfirmaciones(){
    document.getElementById('feedbackUltimoGasto').style.display = 'none';
    document.getElementById('feedbackUltimoIngreso').style.display = 'none';
}

</script>
</body>
</html>